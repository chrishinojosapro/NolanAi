<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotus Protocol Fuzzer</title>
    <style>
        :root {
            --bg: #050505;
            --panel: #111111;
            --accent: #ff0055;
            --text: #ffffff;
        }

        body {
            font-family: monospace;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .terminal {
            width: 100%;
            max-width: 500px;
            background: var(--panel);
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 0 50px rgba(255, 0, 85, 0.1);
        }

        .byte-display {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .byte-box {
            background: #000;
            border: 1px solid #444;
            padding: 10px 0;
            text-align: center;
            font-size: 0.8rem;
            border-radius: 4px;
        }
        .byte-box.active { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 10px rgba(255, 0, 85, 0.3); }

        button {
            width: 100%;
            padding: 15px;
            background: #222;
            color: white;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
        }
        button.primary { background: var(--accent); border-color: var(--accent); }
        
        .log {
            height: 120px;
            background: #000;
            border: 1px solid #222;
            padding: 10px;
            font-size: 0.7rem;
            overflow-y: auto;
            color: #666;
            margin-top: 20px;
        }

        .slider-group {
            text-align: left;
            margin-bottom: 20px;
        }
        label { font-size: 0.7rem; color: #888; display: block; margin-bottom: 5px;}
        input[type=range] { width: 100%; accent-color: var(--accent); }
    </style>
</head>
<body>

    <div class="terminal">
        <h1 style="font-size:1rem; margin:0; letter-spacing:2px;">PROTOCOL FUZZER</h1>
        <p style="font-size:0.7rem; color:#666; margin-bottom:20px;">Searching for hidden Segment/Pixel bytes...</p>

        <button class="primary" onclick="connect()" id="connBtn">1. INITIALIZE LINK</button>

        <div class="byte-display" id="byteContainer">
            <!-- 9 Bytes -->
            <div class="byte-box" id="b0">7E</div>
            <div class="byte-box" id="b1">07</div>
            <div class="byte-box" id="b2">05</div>
            <div class="byte-box" id="b3">03</div>
            <div class="byte-box" id="b4">FF</div>
            <div class="byte-box" id="b5">00</div>
            <div class="byte-box" id="b6">00</div>
            <div class="byte-box" id="b7">00</div>
            <div class="byte-box" id="b8">EF</div>
        </div>

        <div class="slider-group">
            <label>FUZZ SPEED (Current: <span id="spdVal">200</span>ms)</label>
            <input type="range" id="speed" min="50" max="1000" value="200" oninput="document.getElementById('spdVal').innerText=this.value">
        </div>

        <button onclick="toggleFuzz()" id="fuzzBtn">ðŸŽ² START DEEP FUZZ</button>
        <button style="color:var(--accent)" onclick="resetLights()">RESET LIGHTS</button>

        <div class="log" id="log">SYSTEM READY...</div>
    </div>

    <script>
        let device, characteristic;
        let isFuzzing = false;
        let fuzzInt;
        let currentByteToFuzz = 7; // We start at Byte 7 (Address/Index)
        let val = 0;

        function log(msg) {
            const l = document.getElementById('log');
            l.innerHTML = `> ${msg}<br>` + l.innerHTML;
        }

        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                const services = await server.getPrimaryServices();
                for(let s of services) {
                    const chars = await s.getCharacteristics();
                    for(let c of chars) {
                        if(c.properties.write || c.properties.writeWithoutResponse) { characteristic = c; break; }
                    }
                }
                document.getElementById('connBtn').innerText = "CONNECTED";
                document.getElementById('connBtn').style.background = "#22c55e";
                log("Connected to hardware.");
            } catch(e) { log("ERR: " + e.message); }
        }

        function toggleFuzz() {
            if(isFuzzing) stop(); else start();
        }

        function start() {
            if(!characteristic) return alert("Connect first!");
            isFuzzing = true;
            document.getElementById('fuzzBtn').innerText = "â¹ STOP (WATCH LIGHTS!)";
            document.getElementById('fuzzBtn').style.background = "white";
            document.getElementById('fuzzBtn').style.color = "black";
            
            // Fuzz through potential command bytes (Byte 4, 5, 6, 7)
            // 7E 07 05 03 [R] [G] [B] [IDX] EF
            runFuzz();
        }

        function stop() {
            isFuzzing = false;
            clearTimeout(fuzzInt);
            document.getElementById('fuzzBtn').innerText = "ðŸŽ² START DEEP FUZZ";
            document.getElementById('fuzzBtn').style.background = "";
            document.getElementById('fuzzBtn').style.color = "";
            log("Fuzz Halted.");
        }

        async function runFuzz() {
            if(!isFuzzing) return;

            // Generate Fuzz Data
            // We keep Red on [Byte 4] and rotate Byte 7
            val++;
            if(val > 255) {
                val = 0;
                currentByteToFuzz--;
                if(currentByteToFuzz < 5) currentByteToFuzz = 7;
            }

            const cmd = new Uint8Array([0x7e, 0x07, 0x05, 0x03, 0xff, 0x00, 0x00, 0x00, 0xef]);
            cmd[currentByteToFuzz] = val;

            // Update UI
            for(let i=0; i<9; i++) {
                const el = document.getElementById('b'+i);
                el.innerText = cmd[i].toString(16).toUpperCase().padStart(2, '0');
                el.classList.remove('active');
            }
            document.getElementById('b'+currentByteToFuzz).classList.add('active');

            try {
                await characteristic.writeValue(cmd);
            } catch(e){}

            const spd = parseInt(document.getElementById('speed').value);
            fuzzInt = setTimeout(runFuzz, spd);
        }

        async function resetLights() {
            if(!characteristic) return;
            // Send standard "ON" and "RED" to clear glitches
            try {
                await characteristic.writeValue(new Uint8Array([0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef]));
                await characteristic.writeValue(new Uint8Array([0x7e, 0x07, 0x05, 0x03, 0xff, 0x00, 0x00, 0x00, 0xef]));
            } catch(e){}
        }
    </script>
</body>
</html>
