<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nolan AI</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://i.imgur.com/8Qp4R0K.png">

<style>
:root {
--bg:#000;
--glass:rgba(15,15,15,0.72);
--glass-border:rgba(255,255,255,0.08);
--bubble:#111;
--bubble-ai:#141414;
--bubble-user:#1c1c1c;
--text:#fff;
--muted:#bbb;
--radius:22px;
--pill:50px;
--blur:38px;
--font:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial;
}

* {
box-sizing:border-box;
-webkit-tap-highlight-color:transparent;
}

body {
margin:0;
background:var(--bg);
font-family:var(--font);
color:var(--text);
display:flex;
height:100vh;
}

.frost {
background:var(--glass);
border:1px solid var(--glass-border);
backdrop-filter:blur(var(--blur)) saturate(160%);
-webkit-backdrop-filter:blur(var(--blur)) saturate(160%);
border-radius:var(--radius);
}

.app {
max-width:900px;
width:100%;
margin:auto;
padding:14px;
display:flex;
flex-direction:column;
}

.topbar {
padding:16px 18px;
display:flex;
align-items:center;
justify-content:space-between;
border-radius:var(--radius);
margin-bottom:14px;
}

.brand {
display:flex;
align-items:center;
gap:14px;
}

.brand-icon {
height:44px;
width:44px;
border-radius:50%;
background:rgba(0,0,0,0.55);
backdrop-filter:blur(18px);
-webkit-backdrop-filter:blur(18px);
border:1px solid rgba(255,255,255,0.08);
display:flex;
justify-content:center;
align-items:center;
font-weight:700;
font-size:1.6rem;
color:#fff;
}

.status-container {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* New: Make the status display clickable */
#mode-toggle {
    cursor: pointer;
    font-size: .8rem;
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease-in-out;
}

/* Style for Online Mode (Full AI) */
.mode-online {
    background: rgba(0, 150, 255, 0.5);
    color: #d0ffd6;
}

/* Style for Local Mode (Memory Only) */
.mode-local {
    background: rgba(255, 165, 0, 0.5); /* Orange for warning/local */
    color: #ffe6b0;
    border: 1px solid rgba(255, 165, 0, 0.4);
}

#chat {
display:flex;
flex-direction:column;
flex:1;
border-radius:var(--radius);
overflow:hidden;
}

#log {
flex:1;
padding:20px;
overflow-y:auto;
display:flex;
flex-direction:column;
gap:18px;
}

.msg {
display:flex;
gap:12px;
}

.msg.user {
flex-direction:row-reverse;
}

.bubble {
padding:12px 18px;
border-radius:18px;
font-size:.95rem;
line-height:1.45;
max-width:calc(100% - 60px);
background:var(--bubble);
border:1px solid rgba(255,255,255,0.08);
word-wrap:break-word;
}

/* CSS Fix for Paragraph Spacing inside bubbles */
.bubble p {
margin: 0 0 10px 0;
}
.bubble p:last-child {
margin-bottom: 0;
}
/* End CSS Fix */

.msg.ai .bubble { background:var(--bubble-ai); }
.msg.user .bubble { background:var(--bubble-user); }

.briefing-bubble {
background:rgba(50,100,50,0.35) !important;
border:1px solid rgba(50,100,50,0.55) !important;
font-weight:500;
padding:14px 18px;
white-space:pre-wrap;
word-break:break-word;
text-align:left;
max-width:95%;
align-self:flex-start;
border-radius:18px;
}

.offline {
background:#2d2d2d !important;
opacity:0.85;
}

.timestamp {
display:block;
margin-top:6px;
font-size:.65rem;
color:var(--muted);
}

#typing {
padding:12px 20px;
font-size:.85rem;
color:var(--muted);
display:none;
}

.input-bar {
padding:12px;
display:flex;
gap:10px;
align-items:center;
border-top:1px solid var(--glass-border);
}

#msg {
flex:1;
height:48px;
background:rgba(255,255,255,0.08);
border:none;
border-radius:var(--pill);
padding:0 18px;
font-size:1rem;
color:white;
}

#msg:focus { outline:none; }

#send {
height:48px;
padding:0 24px;
background:rgba(255,255,255,0.14);
border:none;
border-radius:var(--pill);
font-weight:600;
color:white;
cursor:pointer;
}

#refresh {
height:40px;
width:40px;
border-radius:50%;
background:rgba(255,255,255,0.08);
border:1px solid rgba(255,255,255,0.12);
color:white;
cursor:pointer;
}
</style>
</head>

<body onload="initNolan()">
<div class="app">
<div class="topbar frost">
<div class="brand">
<div class="brand-icon">‚òÅÔ∏è</div>
<div>
<h1 style="margin:0;font-size:1.2rem;">Nolan</h1>
<div style="font-size:.82rem;color:var(--muted);margin-top:2px;">
Chris's AI Assistant
</div>
</div>
</div>
<div class="status-container">
    <button id="refresh">‚Üª</button>
    <div id="mode-toggle" class="mode-online">Online (Full AI)</div>
</div>
</div>

<div id="chat" class="frost">
<div id="log"></div>
<div id="typing">Nolan is thinking‚Ä¶</div>

<div class="input-bar">
<input id="msg" type="text" placeholder="Talk to Nolan‚Ä¶" autocomplete="off">
<button id="send">Send</button>
</div>
</div>
</div>

<script>
// API deployment URL (must be updated by the user)
const API = "https://script.google.com/macros/s/AKfycbyvzN3NNagKXV2arFhC2PzOcQcganZGZr7_9YJ-dPuFzw4syMjK-HpV2KntcNhahp7S/exec";

const logDiv = document.getElementById("log");
const input = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const typing = document.getElementById("typing");
const modeToggle = document.getElementById("mode-toggle");
const brandIcon = document.querySelector(".brand-icon");

let currentMode = 'online'; // 'online' (Full AI) or 'local' (Memory Only)

// --- Mode Management ---
function setOnlineMode(apiWorking) {
    currentMode = 'online';
    modeToggle.textContent = 'Online (Full AI)'; // Updated to Full AI
    modeToggle.classList.remove('mode-local');
    modeToggle.classList.add('mode-online');
    brandIcon.innerHTML = "‚òÅÔ∏è";
    brandIcon.style.backgroundColor = apiWorking ? "rgba(0,150,255,0.55)" : "rgba(255, 165, 0, 0.5)";
}

function setLocalMode() {
    currentMode = 'local';
    modeToggle.textContent = "Local (Memory Only)";
    modeToggle.classList.remove('mode-online');
    modeToggle.classList.add('mode-local');
    brandIcon.innerHTML = "üß†";
    brandIcon.style.backgroundColor = "rgba(255, 165, 0, 0.5)";
}

function toggleMode() {
    if (currentMode === 'online') {
        setLocalMode();
        addMsg("Switched to Local Mode. I will only respond using stored facts and utilities. No external AI calls will be made.", "ai", true);
    } else {
        setOnlineMode(true);
        addMsg("Switched back to Online Mode. I can now use the external AI model.", "ai");
    }
    // Store mode preference (optional, using localStorage if available)
    if (window.localStorage) {
        localStorage.setItem('nolanMode', currentMode);
    }
    input.focus();
}

modeToggle.addEventListener('click', toggleMode);

// --- Status Updates ---

function setApiStatus(isOnline) {
    // This function now primarily handles visual feedback if we are in 'online' mode
    if (currentMode === 'online') {
        setOnlineMode(isOnline);
    }
}

function setOfflineStatus() {
    // If the API failed, we set the API status visually but keep the mode logic separate
    setApiStatus(false); 
}


function addMsg(raw, who, offline = false) {
let text = String(raw || "");
const tempDiv = document.createElement('div');
tempDiv.innerHTML = text;
text = tempDiv.innerHTML;

if (!text.trim()) {
text = "<p>‚Ä¶no message received.</p>";
}

const row = document.createElement("div");
row.className = `msg ${who}`;

const bubble = document.createElement("div");
bubble.className = "bubble";
bubble.innerHTML = text;

if (offline) {
bubble.classList.add("offline");
}

if (who === "ai" && text.includes("<p>")) {
bubble.classList.add("briefing-bubble");
}

const ts = document.createElement("div");
ts.className = "timestamp";
ts.textContent = new Date().toLocaleTimeString();
bubble.appendChild(ts);

row.appendChild(bubble);
logDiv.appendChild(row);
logDiv.scrollTo({top: logDiv.scrollHeight, behavior: "smooth"});
}

async function send() {
    const msg = input.value.trim();
    if (!msg) return;
    addMsg(msg, "user");

    input.value = "";
    input.disabled = true;
    sendBtn.disabled = true;
    typing.style.display = "block";

    let apiUrl = API;

    if (currentMode === 'local') {
        // In Local Mode, bypass external AI entirely.
        // The Apps Script must read this flag and skip callAI.
        apiUrl += "?q=" + encodeURIComponent(msg) + "&mode=local"; 
    } else {
        apiUrl += "?q=" + encodeURIComponent(msg);
    }

    try {
        const res = await fetch(apiUrl);
        const json = await res.json();
        addMsg(json.reply, "ai");
        setApiStatus(true); // API connection confirmed
    } catch (e) {
        addMsg("Chris‚Ä¶ my connection dropped for a second. Say that again? I'm running in offline/local memory mode until the API recovers.", "ai", true);
        setOfflineStatus();
        setLocalMode(); // Auto-switch to local memory mode on failure
    }

    typing.style.display = "none";
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
}

async function initNolan() {
    // Check for stored mode preference
    if (window.localStorage && localStorage.getItem('nolanMode') === 'local') {
        setLocalMode();
    } else {
        // Initial load is always Online, but we check connectivity
        setOnlineMode(true);
    }

    typing.style.display = "block";
    input.disabled = true;
    sendBtn.disabled = true;

    try {
        const ts = Date.now();
        const res = await fetch(API + "?q=&_ts=" + ts);
        const json = await res.json();
        addMsg(json.reply, "ai");
        setApiStatus(true);
    } catch (e) {
        addMsg("Chris‚Ä¶ I'm here. My external AI connection is currently offline, so I've automatically switched to **Local Memory Mode**.", "ai", true);
        setOfflineStatus();
        setLocalMode();
    }

    typing.style.display = "none";
    input.disabled = false;
    sendBtn.disabled = false;
    input.focus();
}

sendBtn.addEventListener("click", send);
input.addEventListener("keypress", e => { if (e.key === "Enter") send(); });
document.getElementById("refresh").onclick = () => location.reload();
</script>
</body>
</html>
