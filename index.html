<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vader vs Kenobi - Light Sync</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --bg: #000;
            --text: #eee;
            --accent: #eab308;
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        /* LAYOUT */
        .container {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            text-align: center;
        }

        h1 { margin: 10px 0 20px; text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem; }

        /* VIDEO CONTAINER */
        .video-box {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            background: #111;
            border: 2px solid #333;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 0 50px rgba(255, 0, 0, 0.2);
        }
        
        .video-box iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* CONTROLS */
        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            border: 1px solid #333;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        select {
            background: #222;
            color: white;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 6px;
            flex: 1;
        }

        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
        }
        button:hover { filter: brightness(1.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #333; }

        /* SYNC BAR */
        .sync-bar {
            width: 100%;
            height: 10px;
            background: #333;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        .sync-fill {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, red, blue);
            transition: width 0.1s linear;
        }

        /* OFFSET SLIDER */
        .offset-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            color: #888;
        }
        input[type=range] { flex: 1; accent-color: var(--accent); }

        /* STATUS */
        #status { font-family: monospace; color: #22c55e; min-height: 20px; }
        
        /* OVERLAY FLASH */
        #flash {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 100;
            transition: opacity 0.05s;
        }

    </style>
</head>
<body>

    <div id="flash"></div>

    <div class="container">
        <h1>Duel Sync Player</h1>
        
        <div class="video-box">
            <div id="player"></div>
        </div>

        <div class="controls">
            <div class="row">
                <select id="protocol">
                    <option value="1">Protocol: Lotus/Keepsmile</option>
                    <option value="0">Protocol: ELK-BLEDOM</option>
                    <option value="2">Protocol: Triones</option>
                </select>
                <button id="connectBtn" onclick="connect()">ðŸ“¡ Connect Light</button>
            </div>
            
            <div class="offset-wrap">
                <span>Sync Offset:</span>
                <input type="range" min="-1000" max="1000" value="0" step="50" oninput="updateOffset(this.value)">
                <span id="offsetVal">0ms</span>
            </div>

            <div class="sync-bar"><div class="sync-fill" id="syncFill"></div></div>
            <div id="status">Waiting for connection...</div>
        </div>
    </div>

    <script>
        // --- CHOREOGRAPHY (Time in Seconds) ---
        // Scene: Obi-Wan vs Vader (Part 6)
        const EVENTS = [
            { t: 0, c: [0,0,0], note: "Intro Darkness" },
            { t: 147, c: [0,0,0], note: "Vader Arrives" },
            
            // IGNITION
            { t: 148.5, c: [255,0,0], note: "Vader Ignite (Red)" }, 
            { t: 153.0, c: [0,0,255], note: "Obi-Wan Ignite (Blue)" },
            
            // FIRST CLASHES
            { t: 155.5, c: [255,255,255], note: "Clash" },
            { t: 155.7, c: [255,0,0], note: "Red Push" },
            { t: 160.0, c: [0,0,0], note: "Break" },
            
            // THE DUEL (Rapid Fire)
            { t: 165.0, c: [0,0,255], note: "Blue" },
            { t: 166.0, c: [255,0,0], note: "Red" },
            { t: 167.5, c: [255,255,255], note: "Clash" },
            { t: 168.0, c: [255,0,0], note: "Red" },
            { t: 172.0, c: [255,255,255], note: "Clash" },
            { t: 172.3, c: [0,0,255], note: "Blue" },
            
            // FORCE PUSH BATTLE
            { t: 180.0, c: [255,0,0], note: "Vader Force" },
            { t: 185.0, c: [0,0,255], note: "Obi Force" },
            { t: 190.0, c: [255,255,255], note: "Power Struggle" },
            
            // THE PIT (Burial)
            { t: 260.0, c: [100,0,0], note: "Vader Winning" },
            { t: 280.0, c: [50,0,0], note: "Rocks Falling" },
            { t: 300.0, c: [0,0,0], note: "Buried (Dark)" },
            
            // FLASHBACKS / HOPE
            { t: 330.0, c: [0,0,50], note: "Dim Blue Hope" },
            
            // THE ERUPTION
            { t: 350.0, c: [0,0,0], note: "Silence..." },
            { t: 355.0, c: [0,100,255], note: "Rumble..." },
            { t: 358.5, c: [255,255,255], note: "EXPLOSION (Breakout)" },
            { t: 359.0, c: [0,0,255], note: "Full Power Jedi" },
            
            // THE HIGH GROUND
            { t: 370.0, c: [0,0,255], note: "Obi Attack" },
            { t: 375.0, c: [255,255,255], note: "Hit" },
            { t: 376.0, c: [0,0,255], note: "Obi Attack" },
            { t: 380.0, c: [255,255,255], note: "Hit" },
            
            // VADER MASK BREAK
            { t: 400.0, c: [255,100,0], note: "Saber Slash" },
            { t: 405.0, c: [255,0,0], note: "Vader Damaged" },
            
            // DIALOGUE (Emotional)
            { t: 450.0, c: [50,0,20], note: "Red/Blue Mix (Face)" },
            { t: 500.0, c: [0,0,0], note: "Departure" }
        ];

        // --- YOUTUBE API ---
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: 'VO8Bk03Xv90',
                playerVars: { 'playsinline': 1 },
                events: {
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        let syncInterval;
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PLAYING) {
                startSync();
            } else {
                stopSync();
            }
        }

        // --- SYNC ENGINE ---
        let lastEventIndex = -1;
        let syncOffset = 0;

        function startSync() {
            if(syncInterval) clearInterval(syncInterval);
            syncInterval = setInterval(syncLoop, 100);
        }

        function stopSync() {
            clearInterval(syncInterval);
        }

        function updateOffset(val) {
            syncOffset = parseInt(val) / 1000; // Convert ms to s
            document.getElementById('offsetVal').innerText = val + "ms";
        }

        function syncLoop() {
            if (!player || !player.getCurrentTime) return;
            
            const time = player.getCurrentTime() + syncOffset;
            
            // Find current event
            // We want the event that has the largest 't' that is still <= current time
            let currentEventIdx = -1;
            for(let i=0; i<EVENTS.length; i++) {
                if (time >= EVENTS[i].t) {
                    currentEventIdx = i;
                } else {
                    break;
                }
            }

            // If we found a new event we haven't fired yet
            if (currentEventIdx !== -1 && currentEventIdx !== lastEventIndex) {
                const event = EVENTS[currentEventIdx];
                triggerLight(event);
                lastEventIndex = currentEventIdx;
                
                // UI Update
                document.getElementById('status').innerText = `[${time.toFixed(1)}s] ${event.note}`;
                document.getElementById('status').style.color = `rgb(${event.c[0]}, ${event.c[1]}, ${event.c[2]})`;
            }
            
            // Update Bar
            const prog = (time / 550) * 100;
            document.getElementById('syncFill').style.width = prog + "%";
        }

        function triggerLight(ev) {
            const [r, g, b] = ev.c;
            
            // 1. Flash Screen
            if (r+g+b > 600) { // White flash
                document.getElementById('flash').style.opacity = 0.8;
                setTimeout(() => document.getElementById('flash').style.opacity = 0, 50);
            } else {
                document.body.style.backgroundColor = `rgb(${r*0.2}, ${g*0.2}, ${b*0.2})`;
            }

            // 2. Send Bluetooth
            if (characteristic) {
                const pid = document.getElementById('protocol').value;
                const p = PROTOCOLS[pid];
                
                // If Black
                if (r===0 && g===0 && b===0) {
                    characteristic.writeValue(p.off).catch(e=>{});
                } else {
                    // Send ON first to ensure wake
                    if(p.on) characteristic.writeValue(p.on).catch(e=>{});
                    const data = p.write(r,g,b);
                    characteristic.writeValue(data).catch(e=>{});
                }
            }
        }

        // --- BLUETOOTH ---
        const PROTOCOLS = [
            { name: "ELK", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]) },
            { name: "Lotus", write: (r,g,b) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, 0x10, 0xef]), off: new Uint8Array([0x7e, 0x04, 0x04, 0x00, 0x00, 0x00, 0xff, 0x00, 0xef]), on: new Uint8Array([0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef]) },
            { name: "Triones", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]) }
        ];

        let characteristic;

        async function connect() {
            try {
                if (!navigator.bluetooth) throw new Error("Browser not supported");
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                // Find service
                const uuids = ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
                let service;
                for(let u of uuids) { try{ service = await server.getPrimaryService(u); break; }catch(e){} }
                
                const charUUIDs = ['0000ffd9-0000-1000-8000-00805f9b34fb', '0000ffe9-0000-1000-8000-00805f9b34fb', '0000fff3-0000-1000-8000-00805f9b34fb'];
                for(let c of charUUIDs) { try{ characteristic = await service.getCharacteristic(c); break; }catch(e){} }

                if(characteristic) {
                    document.getElementById('status').innerText = "Connected!";
                    document.getElementById('status').style.color = "#22c55e";
                    document.getElementById('connectBtn').style.display = 'none';
                    // Test flash
                    triggerLight({ c: [0,255,0] });
                    setTimeout(() => triggerLight({ c: [0,0,0] }), 500);
                }
            } catch(e) { alert("Connect Error: " + e.message); }
        }

    </script>
</body>
</html>
