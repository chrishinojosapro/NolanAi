<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal LED Controller v5 (Magic Effects)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #8b5cf6;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --music-color: #f43f5e;
            --magic-color: #06b6d4;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: var(--card-color);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h1 { margin: 0 0 0.5rem 0; font-size: 1.5rem; }
        p { color: #888; margin-bottom: 2rem; font-size: 0.9rem; }

        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-bottom: 10px;
        }
        button:active { transform: scale(0.98); }

        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: #444; color: white; }
        .btn-music { background-color: var(--music-color); color: white; }
        .btn-magic { background-color: var(--magic-color); color: white; }

        .hidden { display: none; }

        /* Sections */
        .section-box {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }

        .visualizer-canvas {
            width: 100%;
            height: 60px;
            background: #000;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        input[type="file"] {
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: #ccc;
            width: 100%;
        }

        .slider-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            gap: 10px;
            font-size: 0.85rem;
            color: #aaa;
        }
        input[type="range"] {
            flex-grow: 1;
            accent-color: var(--accent-color);
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 60px;
            cursor: pointer;
            background: none;
            margin-bottom: 10px;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 12px; }

        select {
            width: 100%;
            padding: 12px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        #log {
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #666;
            text-align: left;
            background: #000;
            padding: 10px;
            border-radius: 8px;
            height: 100px;
            overflow-y: auto;
            font-family: monospace;
        }
        
        .tab-btn {
            flex: 1;
            padding: 10px;
            font-size: 0.8rem;
            background: #333;
            border-radius: 8px;
            margin: 0 2px;
        }
        .active-tab { background: var(--accent-color); }
    </style>
</head>
<body>

    <div class="container">
        <h1>Universal Controller</h1>
        <p>Protocol 2 (Lotus) Active</p>

        <!-- Connect Screen -->
        <div id="connectScreen">
            <button id="connectBtn" class="btn-primary">üîç Scan & Connect</button>
        </div>

        <!-- Control Screen -->
        <div id="controlScreen" class="hidden">
            <label for="protocolSelect" style="display:block; text-align:left; margin-bottom:5px; color:#aaa; font-size:0.8rem;">Command Protocol:</label>
            <select id="protocolSelect">
                <option value="0">Protocol 1: Standard (ELK/BLEDOM)</option>
                <option value="1" selected>Protocol 2: Lotus/Keepsmile (0x7E)</option>
                <option value="2">Protocol 3: Triones/Zengge</option>
                <option value="3">Protocol 4: QHM Variant</option>
            </select>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="offBtn" class="btn-danger">OFF</button>
                <button id="onBtn" class="btn-success">ON</button>
            </div>

            <!-- TABS -->
            <div style="display:flex; margin-bottom:10px;">
                <button onclick="showTab('color')" class="tab-btn active-tab" id="tab-color">Color</button>
                <button onclick="showTab('magic')" class="tab-btn" id="tab-magic" style="background:var(--magic-color); color:white;">‚ú® Magic</button>
                <button onclick="showTab('music')" class="tab-btn" id="tab-music" style="background:var(--music-color); color:white;">üéµ Music</button>
            </div>

            <!-- TAB: SOLID COLOR -->
            <div id="section-color">
                <input type="color" id="colorPicker" value="#ff0000">
                <div class="section-box">
                    <h3 style="margin:0 0 10px 0; font-size:1rem;">Presets</h3>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button onclick="startShow('rgb')" style="flex:1; background:#444;">Fade</button>
                        <button onclick="startShow('police')" style="flex:1; background:#0044cc;">Police</button>
                        <button onclick="startShow('strobe')" style="flex:1; background:#cccc00; color:black;">Strobe</button>
                    </div>
                    <button id="stopShowBtn" class="hidden btn-danger" style="margin-top:10px;">‚èπ Stop Show</button>
                </div>
            </div>

            <!-- TAB: MAGIC EFFECTS -->
            <div id="section-magic" class="hidden">
                <div class="section-box" style="border-color: var(--magic-color);">
                    <h3 style="margin:0 0 10px 0; font-size:1rem; color:var(--magic-color);">‚ú® Magic Effects</h3>
                    <p style="font-size:0.8rem; margin-bottom:15px;">Cycle through built-in modes (Rainbow, Stacking, etc.)</p>
                    
                    <div class="slider-row">
                        <span>Mode ID: <span id="modeVal">1</span></span>
                    </div>
                    <input type="range" id="modeRange" min="1" max="200" value="1" oninput="updateMode(this.value)">
                    
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button class="btn-secondary" onclick="changeMode(-1)">Prev</button>
                        <button class="btn-magic" onclick="changeMode(1)">Next</button>
                    </div>

                    <div class="slider-row" style="margin-top:15px;">
                        <span>Speed</span>
                        <input type="range" id="effectSpeed" min="1" max="100" value="80" onchange="updateSpeed(this.value)">
                    </div>
                </div>
            </div>

            <!-- TAB: MUSIC -->
            <div id="section-music" class="hidden">
                <div class="section-box" style="border-color: var(--music-color);">
                    <h3 style="margin:0 0 10px 0; font-size:1rem; color:var(--music-color);">üéµ Music Sync</h3>
                    <input type="file" id="audioFile" accept="audio/*">
                    <audio id="audioPlayer" controls style="width:100%; margin-top:5px;"></audio>
                    <canvas id="visualizer" class="visualizer-canvas"></canvas>
                    <div style="margin-top:10px; font-size:0.8rem; color:#aaa;">
                        Play audio to sync lights to bass.
                    </div>
                </div>
            </div>
            
            <button id="disconnectBtn" style="background: #333; margin-top: 20px;">Disconnect</button>
        </div>

        <div id="log">Logs will appear here...</div>
    </div>

    <script>
        // --- COMMAND PROTOCOLS ---
        const COMMAND_SETS = [
            {
                name: "Standard (ELK/BLEDOM)",
                writeColor: (r, g, b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]),
                setMode: (mode, speed) => new Uint8Array([0xBB, mode, speed, 0x44]), // Generic
                on: new Uint8Array([0xcc, 0x23, 0x33]),
                off: new Uint8Array([0xcc, 0x24, 0x33])
            },
            {
                name: "Lotus/Keepsmile (0x7E)",
                writeColor: (r, g, b) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, 0x10, 0xef]),
                // Addressable Mode Command: 7E 05 03 <Mode> <Speed> FF FF 00 EF
                setMode: (mode, speed) => new Uint8Array([0x7e, 0x05, 0x03, mode, 0x03, 0xff, 0xff, 0x00, 0xef]),
                on: new Uint8Array([0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef]),
                off: new Uint8Array([0x7e, 0x04, 0x04, 0x00, 0x00, 0x00, 0xff, 0x00, 0xef])
            },
            {
                name: "Triones/Zengge",
                writeColor: (r, g, b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]),
                setMode: (mode, speed) => new Uint8Array([0xBB, mode, speed, 0x44]),
                on: new Uint8Array([0xcc, 0x23, 0x33]),
                off: new Uint8Array([0xcc, 0x24, 0x33])
            },
            {
                name: "QHM Variant",
                writeColor: (r, g, b) => new Uint8Array([0x56, 0x00, r, g, b, 0xf0, 0xaa]),
                setMode: (mode, speed) => new Uint8Array([0xBB, mode, speed, 0x44]),
                on: new Uint8Array([0xcc, 0x23, 0x33]),
                off: new Uint8Array([0xcc, 0x24, 0x33])
            }
        ];

        // Known UUIDs
        const SERVICES = [
            '0000ffd5-0000-1000-8000-00805f9b34fb',
            '0000ffe5-0000-1000-8000-00805f9b34fb',
            '0000fff0-0000-1000-8000-00805f9b34fb',
            '0000ffe0-0000-1000-8000-00805f9b34fb'
        ];
        
        const CHARACTERISTICS = [
            '0000ffd9-0000-1000-8000-00805f9b34fb',
            '0000ffe9-0000-1000-8000-00805f9b34fb',
            '0000fff3-0000-1000-8000-00805f9b34fb',
            '0000ffe1-0000-1000-8000-00805f9b34fb'
        ];

        // --- STATE ---
        let device, characteristic;
        let showInterval = null; 
        let currentMode = 1;
        
        // --- AUDIO STATE ---
        let audioCtx, analyser, dataArray;
        let isAudioSetup = false;
        let lastBeatTime = 0;
        let beatColors = [[255,0,0], [0,0,255], [0,255,0], [255,0,255], [0,255,255], [255,255,0]];
        let beatColorIndex = 0;

        // --- UI ELEMENTS ---
        const logBox = document.getElementById('log');
        const protocolSelect = document.getElementById('protocolSelect');

        function log(msg) {
            logBox.innerText = `> ${msg}\n` + logBox.innerText;
        }

        // --- TABS ---
        window.showTab = function(tabName) {
            ['color', 'magic', 'music'].forEach(t => {
                document.getElementById('section-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).style.opacity = '0.6';
            });
            document.getElementById('section-' + tabName).classList.remove('hidden');
            document.getElementById('tab-' + tabName).style.opacity = '1.0';
        }

        // --- CONNECTION LOGIC ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) throw new Error("Web Bluetooth not supported (Use Bluefy App)");
                log("Scanning...");
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: SERVICES
                });

                log(`Connecting to ${device.name}...`);
                
                device.addEventListener('gattserverdisconnected', () => {
                    log("Disconnected.");
                    document.getElementById('connectScreen').classList.remove('hidden');
                    document.getElementById('controlScreen').classList.add('hidden');
                });

                const server = await device.gatt.connect();
                
                // Find valid service
                let service = null;
                for (let uuid of SERVICES) {
                    try {
                        service = await server.getPrimaryService(uuid);
                        break;
                    } catch (e) { }
                }
                if (!service) throw new Error("No service found.");

                // Find valid char
                let char = null;
                for (let uuid of CHARACTERISTICS) {
                    try {
                        char = await service.getCharacteristic(uuid);
                        break;
                    } catch (e) { }
                }
                if (!char) {
                     const chars = await service.getCharacteristics();
                     if(chars.length > 0) char = chars[0];
                     else throw new Error("No characteristic found.");
                }
                
                characteristic = char;
                document.getElementById('connectScreen').classList.add('hidden');
                document.getElementById('controlScreen').classList.remove('hidden');
                log("Connected.");

            } catch (err) {
                log("Error: " + err.message);
            }
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (device && device.gatt.connected) device.gatt.disconnect();
        });

        // --- SEND COMMANDS ---
        async function send(data) {
            if (!characteristic) return;
            try {
                await characteristic.writeValue(data);
            } catch (e) { }
        }

        function getActiveProtocol() {
            return COMMAND_SETS[protocolSelect.value];
        }

        document.getElementById('onBtn').addEventListener('click', () => send(getActiveProtocol().on));
        document.getElementById('offBtn').addEventListener('click', () => {
            stopShow();
            send(getActiveProtocol().off);
        });

        // --- MAGIC EFFECTS LOGIC ---
        window.updateMode = function(val) {
            currentMode = parseInt(val);
            document.getElementById('modeVal').innerText = currentMode;
            // Debounce slightly to avoid flooding
            if(window.modeTimeout) clearTimeout(window.modeTimeout);
            window.modeTimeout = setTimeout(() => {
                const proto = getActiveProtocol();
                if(proto.setMode) send(proto.setMode(currentMode, 3)); // Default speed 3
            }, 50);
        };

        window.changeMode = function(delta) {
            let newVal = currentMode + delta;
            if(newVal < 1) newVal = 200;
            if(newVal > 200) newVal = 1;
            document.getElementById('modeRange').value = newVal;
            updateMode(newVal);
        };

        window.updateSpeed = function(val) {
            // Some protocols support speed setting
            // For now we just resend the mode with new speed might work for some
        };

        const colorPicker = document.getElementById('colorPicker');
        let debounce;
        
        colorPicker.addEventListener('input', (e) => {
            stopShow(); 
            clearTimeout(debounce);
            debounce = setTimeout(() => {
                const hex = e.target.value;
                const r = parseInt(hex.substring(1, 3), 16);
                const g = parseInt(hex.substring(3, 5), 16);
                const b = parseInt(hex.substring(5, 7), 16);
                send(getActiveProtocol().writeColor(r, g, b));
            }, 100);
        });

        // --- MUSIC ENGINE ---
        const audioInput = document.getElementById('audioFile');
        const audioPlayer = document.getElementById('audioPlayer');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');

        audioInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const objectUrl = URL.createObjectURL(file);
                audioPlayer.src = objectUrl;
                log("Audio loaded. Press Play.");
                if (!isAudioSetup) setupAudioContext();
            }
        });

        function setupAudioContext() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(audioPlayer);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            isAudioSetup = true;
            visualize();
        }

        function visualize() {
            requestAnimationFrame(visualize);
            
            // Get frequency data (0-255)
            analyser.getByteFrequencyData(dataArray);

            // Draw Background
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            // Simple Beat Detection Algorithm
            let bassTotal = 0;
            let bassCount = 0;
            for(let i = 0; i < 10; i++) { 
                 bassTotal += dataArray[i];
                 bassCount++;
            }
            const bassLevel = bassTotal / bassCount;

            // Draw bars
            for(let i = 0; i < dataArray.length; i++) {
                barHeight = dataArray[i] / 2;
                ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }

            // --- LIGHT SYNC LOGIC ---
            const now = Date.now();
            if (bassLevel > 180 && (now - lastBeatTime > 150)) {
                
                // Beat Detected!
                const proto = getActiveProtocol();
                if(proto && characteristic) {
                    const col = beatColors[beatColorIndex % beatColors.length];
                    characteristic.writeValue(proto.writeColor(col[0], col[1], col[2])).catch(e => {});
                    beatColorIndex++;
                    lastBeatTime = now;
                }
            }
        }

        // --- LEGACY SHOWS ---
        const stopBtn = document.getElementById('stopShowBtn');

        window.stopShow = function() {
            if (showInterval) {
                clearInterval(showInterval);
                showInterval = null;
                stopBtn.classList.add('hidden');
                log("Show stopped.");
            }
        };

        stopBtn.addEventListener('click', window.stopShow);

        window.startShow = function(type) {
            stopShow();
            stopBtn.classList.remove('hidden');
            
            const proto = getActiveProtocol();
            if(!proto) { log("Connect first!"); return; }

            let step = 0;
            let sequence = [];

            const patterns = {
                'rgb': [
                    [255, 0, 0], [0, 255, 0], [0, 0, 255], 
                    [255, 255, 0], [0, 255, 255], [255, 0, 255]
                ],
                'police': [
                    [255, 0, 0], [0, 0, 255], [255, 0, 0], [0, 0, 255]
                ],
                'strobe': [
                    [255, 255, 255], [0, 0, 0]
                ]
            };
            sequence = patterns[type];

            showInterval = setInterval(() => {
                const color = sequence[step % sequence.length];
                send(proto.writeColor(color[0], color[1], color[2]));
                step++;
            }, 500);
        };

    </script>
</body>
</html>
