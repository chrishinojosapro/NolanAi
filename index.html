<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Light Capability Scanner</title>
    <style>
        :root {
            --bg-color: #111;
            --panel-bg: #222;
            --text-color: #eee;
            --accent: #0ea5e9;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body {
            font-family: monospace;
            background: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* CARD STYLE */
        .panel {
            background: var(--panel-bg);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        h2 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; font-size: 1.2rem; }
        
        button {
            padding: 10px 15px;
            cursor: pointer;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
            font-family: inherit;
        }
        button:hover { background: #444; }
        button.primary { background: var(--accent); border-color: var(--accent); }
        button.success { background: var(--success); border-color: var(--success); }
        
        input, select {
            background: #111;
            color: white;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
        }

        /* GRID LAYOUTS */
        .control-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* OUTPUT BOX */
        textarea {
            width: 100%;
            height: 150px;
            background: #000;
            color: #0f0;
            border: 1px solid #333;
            font-family: monospace;
            font-size: 0.8rem;
            padding: 10px;
            box-sizing: border-box;
        }

        .highlight { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body>

    <h1>ðŸ”¦ Light Scanner</h1>
    
    <!-- 1. CONNECT -->
    <div class="panel">
        <h2>1. Connection & Protocol</h2>
        <div class="control-row">
            <select id="protocol" style="flex:1">
                <option value="1">Protocol: Lotus (Keepsmile)</option>
                <option value="0">Protocol: ELK (Standard)</option>
                <option value="2">Protocol: Triones</option>
            </select>
            <button id="connectBtn" class="primary">Connect</button>
        </div>
        <div id="status" style="color: #666; font-size: 0.8rem;">Status: Disconnected</div>
    </div>

    <!-- 2. COLOR CALIBRATION -->
    <div class="panel">
        <h2>2. Color Calibration</h2>
        <p style="font-size:0.8rem; color:#aaa;">Click RED. If light is not Red, change Byte Order.</p>
        <div class="control-row">
            <button onclick="sendColor(255,0,0)" style="border-left: 5px solid red;">Send RED</button>
            <button onclick="sendColor(0,255,0)" style="border-left: 5px solid green;">Send GREEN</button>
            <button onclick="sendColor(0,0,255)" style="border-left: 5px solid blue;">Send BLUE</button>
        </div>
        <div class="control-row">
            <label>Byte Order:</label>
            <select id="byteOrder" onchange="testColor()">
                <option value="RGB">RGB (Standard)</option>
                <option value="GRB">GRB (Swapped)</option>
                <option value="BGR">BGR (Swapped)</option>
            </select>
        </div>
    </div>

    <!-- 3. MODE DISCOVERY -->
    <div class="panel">
        <h2>3. Mode Discovery</h2>
        
        <div class="control-row" style="justify-content: space-between; background: #000; padding: 10px; border-radius: 6px;">
            <button onclick="changeMode(-1)">â—€ Prev</button>
            <span style="font-size:1.5rem; font-weight:bold;" id="modeDisplay">Mode 1</span>
            <button onclick="changeMode(1)">Next â–¶</button>
        </div>

        <div class="control-row">
            <button onclick="testMode()" style="flex:1">Test Again</button>
            <button id="scanBtn" onclick="toggleScan()" style="flex:1">â–¶ Auto-Scan</button>
        </div>

        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 15px;">
            <label style="font-size:0.8rem; display:block; margin-bottom:5px;">What do you see?</label>
            <div class="control-row">
                <input type="text" id="descInput" placeholder="e.g. Red Stacking, Blue Fire..." style="flex:1;">
                <button class="success" onclick="saveEntry()">Save Entry</button>
            </div>
        </div>
    </div>

    <!-- 4. LIBRARY OUTPUT -->
    <div class="panel">
        <h2>4. Library Output</h2>
        <p style="font-size:0.8rem; color:#aaa;">Copy this code and paste it to the AI.</p>
        <textarea id="outputArea" readonly>// Detected Capabilities:
{
  "protocol": "lotus",
  "order": "RGB",
  "modes": {}
}</textarea>
        <div class="control-row" style="margin-top:10px;">
            <button onclick="copyToClipboard()" style="width:100%">Copy to Clipboard</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let device, characteristic;
        let currentMode = 1;
        let library = {
            protocol: "lotus",
            order: "RGB",
            modes: {}
        };
        let scanInterval = null;

        // --- PROTOCOLS ---
        const PROTOCOLS = [
            { name: "elk", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), setMode: (m) => new Uint8Array([0xBB, m, 0x03, 0x44]) },
            { name: "lotus", write: (r,g,b) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, 0x10, 0xef]), setMode: (m) => new Uint8Array([0x7e, 0x05, 0x03, m, 0x03, 0xff, 0xff, 0x00, 0xef]) },
            { name: "triones", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), setMode: (m) => new Uint8Array([0xBB, m, 0x03, 0x44]) }
        ];

        // --- BLUETOOTH ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) throw new Error("Bluetooth not supported.");
                document.getElementById('status').innerText = "Status: Scanning...";
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb']
                });

                const server = await device.gatt.connect();
                
                // Find service (Standard UUIDs)
                const uuids = ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
                let service;
                for(let u of uuids) { try{ service = await server.getPrimaryService(u); break; }catch(e){} }
                if(!service) throw new Error("No service found");

                const charUUIDs = ['0000ffd9-0000-1000-8000-00805f9b34fb', '0000ffe9-0000-1000-8000-00805f9b34fb', '0000fff3-0000-1000-8000-00805f9b34fb'];
                for(let c of charUUIDs) { try{ characteristic = await service.getCharacteristic(c); break; }catch(e){} }

                if(characteristic) {
                    document.getElementById('status').innerText = "Status: Connected to " + device.name;
                    document.getElementById('status').style.color = "#22c55e";
                    
                    // Update library protocol
                    const pIndex = document.getElementById('protocol').value;
                    library.protocol = PROTOCOLS[pIndex].name;
                    updateOutput();
                }
            } catch(e) { 
                document.getElementById('status').innerText = "Error: " + e.message;
            }
        });

        // --- COMMANDS ---
        async function sendColor(r, g, b) {
            if(!characteristic) return;
            
            // Apply Byte Order
            const order = document.getElementById('byteOrder').value;
            let finalR = r, finalG = g, finalB = b;
            
            if(order === 'GRB') { finalR = g; finalG = r; finalB = b; }
            if(order === 'BGR') { finalR = b; finalG = g; finalB = r; }
            
            library.order = order;
            updateOutput();

            const pIndex = document.getElementById('protocol').value;
            const data = PROTOCOLS[pIndex].write(finalR, finalG, finalB);
            try { await characteristic.writeValue(data); } catch(e){}
        }

        async function testMode() {
            if(!characteristic) return;
            const pIndex = document.getElementById('protocol').value;
            const data = PROTOCOLS[pIndex].setMode(currentMode);
            try { await characteristic.writeValue(data); } catch(e){}
        }

        // --- UI LOGIC ---
        function changeMode(delta) {
            currentMode += delta;
            if(currentMode < 1) currentMode = 200;
            if(currentMode > 200) currentMode = 1;
            
            document.getElementById('modeDisplay').innerText = "Mode " + currentMode;
            document.getElementById('descInput').value = library.modes[currentMode] || ""; // Load existing if saved
            testMode();
        }

        function saveEntry() {
            const desc = document.getElementById('descInput').value;
            if(!desc) return;
            
            library.modes[currentMode] = desc;
            updateOutput();
            
            // Visual feedback
            const btn = document.querySelector('button.success');
            const originalText = btn.innerText;
            btn.innerText = "Saved!";
            setTimeout(() => btn.innerText = originalText, 1000);
        }

        function updateOutput() {
            document.getElementById('outputArea').value = JSON.stringify(library, null, 2);
        }

        function copyToClipboard() {
            const copyText = document.getElementById("outputArea");
            copyText.select();
            document.execCommand("copy");
            alert("Copied to clipboard!");
        }

        function toggleScan() {
            const btn = document.getElementById('scanBtn');
            if(scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
                btn.innerText = "â–¶ Auto-Scan";
                btn.style.background = "#333";
            } else {
                btn.innerText = "â¹ STOP";
                btn.style.background = "#ef4444";
                scanInterval = setInterval(() => {
                    changeMode(1);
                }, 2000); // 2 seconds per mode
            }
        }

    </script>
</body>
</html>
