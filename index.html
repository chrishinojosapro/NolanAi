<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI FX Studio</title>
    <style>
        :root {
            --bg: #09090b;
            --panel: #18181b;
            --border: #27272a;
            --text: #e4e4e7;
            --accent: #8b5cf6; /* Violet */
            --accent-hover: #7c3aed;
            --success: #10b981;
            --danger: #ef4444;
            --sfx-1: #3b82f6;
            --sfx-2: #f59e0b;
            --sfx-3: #ec4899;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* CONTAINER */
        .app-container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* HEADER */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        
        .status-badge {
            font-size: 0.75rem; background: #27272a; padding: 4px 8px; border-radius: 4px; color: #71717a; border: 1px solid #3f3f46;
        }
        .status-badge.connected { color: var(--success); border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }

        /* SECTIONS */
        .section {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .section-title { margin: 0 0 15px 0; font-size: 0.9rem; font-weight: 600; color: #a1a1aa; text-transform: uppercase; letter-spacing: 0.5px; }

        /* AUDIO GRID */
        .audio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .file-upload {
            position: relative;
            background: #27272a;
            border: 1px dashed #52525b;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
            color: #a1a1aa;
        }
        .file-upload:hover { border-color: var(--text); color: var(--text); background: #3f3f46; }
        .file-upload.loaded { border-style: solid; background: rgba(255,255,255,0.05); }
        .file-upload.sfx1.loaded { border-color: var(--sfx-1); color: var(--sfx-1); }
        .file-upload.sfx2.loaded { border-color: var(--sfx-2); color: var(--sfx-2); }
        .file-upload.sfx3.loaded { border-color: var(--sfx-3); color: var(--sfx-3); }
        
        .file-upload input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }

        /* PROMPT AREA */
        textarea {
            width: 100%;
            height: 100px;
            background: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            padding: 12px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        textarea:focus { outline: none; border-color: var(--accent); }

        .api-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .api-input { flex: 1; background: #000; border: 1px solid var(--border); color: var(--text); padding: 10px; border-radius: 6px; }

        /* BUTTONS */
        button {
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.95rem;
        }
        button:hover { filter: brightness(1.2); }
        button:active { transform: scale(0.98); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-gen { background: var(--accent); color: white; width: 100%; }
        .btn-play { background: var(--success); color: black; flex: 2; font-size: 1.1rem;}
        .btn-stop { background: var(--danger); color: white; flex: 1; }
        .btn-connect { background: #3f3f46; color: white; padding: 6px 12px; font-size: 0.8rem; }

        /* SCRIPT VIEWER */
        .script-view {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #a1a1aa;
        }
        .script-line { display: flex; gap: 10px; padding: 4px 0; border-bottom: 1px solid #222; }
        .script-time { color: var(--accent); min-width: 50px; }
        .script-action { flex: 1; }
        .script-line.active { background: rgba(255,255,255,0.1); color: white; }

        /* PROGRESS */
        .progress-bar {
            height: 4px; width: 100%; background: #27272a; margin-top: 20px; border-radius: 2px; overflow: hidden;
        }
        .progress-fill { height: 100%; width: 0%; background: var(--success); transition: width 0.1s linear; }

        .control-row { display: flex; gap: 10px; margin-top: 10px; }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <h1>AI FX Studio</h1>
                <div id="connectionStatus" class="status-badge">Disconnected</div>
            </div>
            <div style="display:flex; gap:10px;">
                <select id="protocolSelect" style="background:#27272a; color:#fff; border:1px solid #3f3f46; border-radius:6px; padding:5px;">
                    <option value="1">Lotus/Keepsmile</option>
                    <option value="0">ELK-BLEDOM</option>
                    <option value="2">Triones</option>
                </select>
                <button class="btn-connect" id="connectBtn" onclick="connect()">üì° Connect</button>
            </div>
        </header>

        <!-- 1. AUDIO ASSETS -->
        <div class="section">
            <h2 class="section-title">1. Upload Assets</h2>
            <div class="audio-grid">
                <label class="file-upload" id="lbl-bg">
                    üéµ Backing Track
                    <input type="file" accept="audio/*" onchange="loadAudio('bg', this)">
                </label>
                <label class="file-upload sfx1" id="lbl-sfx1">
                    üîµ SFX 1 (Start/Ignite)
                    <input type="file" accept="audio/*" onchange="loadAudio('sfx1', this)">
                </label>
                <label class="file-upload sfx2" id="lbl-sfx2">
                    üí• SFX 2 (Clash/Hit)
                    <input type="file" accept="audio/*" onchange="loadAudio('sfx2', this)">
                </label>
                <label class="file-upload sfx3" id="lbl-sfx3">
                    üîª SFX 3 (End/Retract)
                    <input type="file" accept="audio/*" onchange="loadAudio('sfx3', this)">
                </label>
            </div>
        </div>

        <!-- 2. AI GENERATOR -->
        <div class="section">
            <h2 class="section-title">2. AI Choreography</h2>
            <div class="api-row">
                <input type="password" id="apiKey" class="api-input" placeholder="OpenRouter API Key (sk-or-v1...)" onchange="saveKey()">
            </div>
            <textarea id="promptInput" placeholder="Describe your show... (e.g. 'Slow build up with blue light for 5s, then ignite red saber (SFX1), wait 2s, then violent clashes (SFX2) every second for 10s.')"></textarea>
            <button class="btn-gen" id="genBtn" onclick="generateShow()">‚ú® Generate Show with DeepSeek</button>
        </div>

        <!-- 3. PLAYBACK -->
        <div class="section">
            <h2 class="section-title">3. Run Show</h2>
            <div class="script-view" id="scriptView">
                <div style="text-align:center; padding-top:80px; color:#444;">Script will appear here...</div>
            </div>
            
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;" id="timeDisplay">0:00</div>

            <div class="control-row">
                <button class="btn-play" id="playBtn" onclick="togglePlay()" disabled>‚ñ∂ Run Show</button>
                <button class="btn-stop" onclick="stopShow()">‚èπ Reset</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const PROTOCOLS = [
            { name: "ELK", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]) },
            { name: "Lotus", write: (r,g,b) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, 0x10, 0xef]), off: new Uint8Array([0x7e, 0x04, 0x04, 0x00, 0x00, 0x00, 0xff, 0x00, 0xef]), on: new Uint8Array([0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef]) },
            { name: "Triones", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]) }
        ];

        // --- STATE ---
        let characteristic;
        let audioBuffers = { bg: null, sfx1: null, sfx2: null, sfx3: null };
        let showEvents = [];
        let isPlaying = false;
        let startTime = 0;
        let animationFrame;
        
        // --- INIT ---
        const storedKey = localStorage.getItem('openrouter_key');
        if(storedKey) document.getElementById('apiKey').value = storedKey;

        // --- AUDIO ENGINE ---
        function loadAudio(slot, input) {
            const file = input.files[0];
            if(!file) return;
            
            const url = URL.createObjectURL(file);
            audioBuffers[slot] = new Audio(url);
            
            // UI
            const lbl = document.getElementById('lbl-'+slot);
            lbl.classList.add('loaded');
            lbl.innerHTML = (slot === 'bg' ? 'üéµ' : 'üîä') + ' ' + file.name;
        }

        function playSound(slot) {
            const audio = audioBuffers[slot];
            if(audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.warn("Audio play blocked", e));
            }
        }
        
        function stopAllSound() {
            Object.values(audioBuffers).forEach(a => {
                if(a) { a.pause(); a.currentTime = 0; }
            });
        }

        // --- LIGHT CONTROL ---
        async function sendEvent(ev) {
            if(!characteristic) return;
            const pid = document.getElementById('protocolSelect').value;
            const p = PROTOCOLS[pid];

            try {
                if (ev.type === 'off') {
                    await characteristic.writeValue(p.off);
                } else if (ev.type === 'flash') {
                    // Flash is white then OFF
                    await characteristic.writeValue(p.write(255,255,255));
                    setTimeout(() => characteristic.writeValue(p.off), 100);
                } else {
                    // Color
                    const hex = ev.color || "#000000";
                    const r = parseInt(hex.substring(1,3), 16);
                    const g = parseInt(hex.substring(3,5), 16);
                    const b = parseInt(hex.substring(5,7), 16);
                    
                    // Auto-wake
                    if(p.on && (r>0||g>0||b>0)) await characteristic.writeValue(p.on);
                    
                    await characteristic.writeValue(p.write(r,g,b));
                }
            } catch(e) { console.error("BT Error", e); }
        }

        // --- AI GENERATOR ---
        function saveKey() {
            localStorage.setItem('openrouter_key', document.getElementById('apiKey').value);
        }

        async function generateShow() {
            const key = document.getElementById('apiKey').value;
            const prompt = document.getElementById('promptInput').value;
            const btn = document.getElementById('genBtn');
            
            if(!key) return alert("Please enter OpenRouter API Key");
            if(!prompt) return alert("Please enter a prompt");
            
            btn.innerText = "Generating... (DeepSeek)";
            btn.disabled = true;

            const system = `
            You are a Lighting Director.
            Available SFX: sfx1, sfx2, sfx3.
            Output JSON array of events sorted by time.
            Schema: { "time": float (seconds), "type": "color"|"off"|"flash", "color": "#hex", "sound": "sfx1"|"sfx2"|"sfx3"|null, "desc": "string" }
            "flash" = White burst (for impacts).
            "off" = Blackout.
            `;

            try {
                const res = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`,
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AI FX Studio'
                    },
                    body: JSON.stringify({
                        model: "deepseek/deepseek-chat",
                        messages: [
                            { role: "system", content: system },
                            { role: "user", content: prompt }
                        ]
                    })
                });
                
                const data = await res.json();
                let content = data.choices[0].message.content;
                content = content.replace(/```json/g, '').replace(/```/g, '').trim();
                
                showEvents = JSON.parse(content);
                renderScript();
                
                btn.innerText = "‚ú® Generate Show with DeepSeek";
                btn.disabled = false;
                document.getElementById('playBtn').disabled = false;
                alert(`Generated ${showEvents.length} events!`);

            } catch(e) {
                alert("AI Error: " + e.message);
                btn.innerText = "Error (Try Again)";
                btn.disabled = false;
            }
        }

        function renderScript() {
            const container = document.getElementById('scriptView');
            container.innerHTML = "";
            showEvents.forEach((ev, i) => {
                const div = document.createElement('div');
                div.className = 'script-line';
                div.id = 'line-'+i;
                
                let sfxBadge = ev.sound ? `<span style="color:var(--sfx-2)">[${ev.sound.toUpperCase()}]</span>` : "";
                let colorBadge = ev.color ? `<span style="color:${ev.color}">‚óè</span>` : "";
                if(ev.type === 'flash') colorBadge = "‚ö°";
                if(ev.type === 'off') colorBadge = "‚ö´";
                
                div.innerHTML = `
                    <div class="script-time">${ev.time.toFixed(1)}s</div>
                    <div class="script-action">${colorBadge} ${ev.desc} ${sfxBadge}</div>
                `;
                container.appendChild(div);
            });
        }

        // --- PLAYBACK ENGINE ---
        function togglePlay() {
            if(isPlaying) stopShow();
            else runShow();
        }

        function runShow() {
            if(showEvents.length === 0) return alert("Generate or Load a show first!");
            
            isPlaying = true;
            startTime = Date.now();
            document.getElementById('playBtn').innerText = "Running...";
            
            // Start BG Music
            playSound('bg');
            
            // Reset executed flags
            showEvents.forEach(e => e.executed = false);
            
            loop();
        }

        function stopShow() {
            isPlaying = false;
            cancelAnimationFrame(animationFrame);
            stopAllSound();
            sendEvent({ type: 'off' }); // Kill lights
            document.getElementById('playBtn').innerText = "‚ñ∂ Run Show";
            document.querySelector('.progress-fill').style.width = "0%";
            document.getElementById('timeDisplay').innerText = "0:00";
        }

        function loop() {
            if(!isPlaying) return;
            
            const now = (Date.now() - startTime) / 1000;
            const maxTime = showEvents[showEvents.length-1].time + 2;
            
            // Update UI
            document.querySelector('.progress-fill').style.width = (now/maxTime)*100 + "%";
            document.getElementById('timeDisplay').innerText = now.toFixed(1);
            
            // Trigger Events
            showEvents.forEach((ev, i) => {
                if (ev.time <= now && !ev.executed) {
                    // FIRE
                    sendEvent(ev);
                    if(ev.sound) playSound(ev.sound);
                    
                    // Mark done
                    ev.executed = true;
                    
                    // Highlight Line
                    document.querySelectorAll('.script-line').forEach(l => l.classList.remove('active'));
                    const el = document.getElementById('line-'+i);
                    if(el) {
                        el.classList.add('active');
                        el.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }
            });
            
            if (now > maxTime) stopShow();
            else animationFrame = requestAnimationFrame(loop);
        }

        // --- BLUETOOTH CONNECT ---
        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                // Find service
                const uuids = ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
                let service;
                for(let u of uuids) { try{ service = await server.getPrimaryService(u); break; }catch(e){} }
                const charUUIDs = ['0000ffd9-0000-1000-8000-00805f9b34fb', '0000ffe9-0000-1000-8000-00805f9b34fb', '0000fff3-0000-1000-8000-00805f9b34fb'];
                for(let c of charUUIDs) { try{ characteristic = await service.getCharacteristic(c); break; }catch(e){} }

                if(characteristic) {
                    const badge = document.getElementById('connectionStatus');
                    badge.innerText = "Connected";
                    badge.classList.add('connected');
                    document.getElementById('connectBtn').style.display = 'none';
                    // Force Off
                    sendEvent({ type: 'off' });
                }
            } catch(e) { alert("Error: " + e.message); }
        }
    </script>
</body>
</html>
