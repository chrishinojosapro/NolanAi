<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal LED Controller v4 (Music Edition)</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #8b5cf6;
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --music-color: #f43f5e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: var(--card-color);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        h1 { margin: 0 0 0.5rem 0; font-size: 1.5rem; }
        p { color: #888; margin-bottom: 2rem; font-size: 0.9rem; }

        button {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-bottom: 10px;
        }
        button:active { transform: scale(0.98); }

        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: #444; color: white; }
        .btn-music { background-color: var(--music-color); color: white; }

        .hidden { display: none; }

        /* Light Show & Builder Styles */
        .show-controls {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }
        
        /* Music Visualizer Styles */
        .music-area {
            background: #2a1b1b;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            margin-bottom: 15px;
            border: 1px solid #442222;
        }

        .visualizer-canvas {
            width: 100%;
            height: 60px;
            background: #000;
            border-radius: 8px;
            margin-top: 10px;
        }
        
        input[type="file"] {
            margin-bottom: 10px;
            font-size: 0.8rem;
            color: #ccc;
            width: 100%;
        }

        .builder-area {
            background: #252525;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .sequence-display {
            display: flex;
            gap: 5px;
            height: 30px;
            margin: 10px 0;
            background: #111;
            border-radius: 6px;
            padding: 5px;
            overflow-x: auto;
            justify-content: flex-start;
        }

        .seq-dot {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 1px solid #555;
            flex-shrink: 0;
        }

        .speed-control {
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #aaa;
            font-size: 0.9rem;
        }
        input[type="range"] {
            width: 100px;
            accent-color: var(--accent-color);
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 100%;
            height: 60px;
            cursor: pointer;
            background: none;
            margin-bottom: 10px;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 12px; }

        select {
            width: 100%;
            padding: 12px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        #log {
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #666;
            text-align: left;
            background: #000;
            padding: 10px;
            border-radius: 8px;
            height: 100px;
            overflow-y: auto;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Universal Controller</h1>
        <p>Protocol 2 Active | Music Ready</p>

        <!-- Connect Screen -->
        <div id="connectScreen">
            <button id="connectBtn" class="btn-primary">üîç Scan & Connect</button>
        </div>

        <!-- Control Screen -->
        <div id="controlScreen" class="hidden">
            <label for="protocolSelect" style="display:block; text-align:left; margin-bottom:5px; color:#aaa; font-size:0.8rem;">Command Protocol:</label>
            <select id="protocolSelect">
                <option value="0">Protocol 1: Standard (ELK/BLEDOM)</option>
                <option value="1" selected>Protocol 2: Lotus/Keepsmile (0x7E)</option>
                <option value="2">Protocol 3: Triones/Zengge</option>
                <option value="3">Protocol 4: QHM Variant</option>
            </select>

            <!-- MUSIC SECTION -->
            <div class="music-area">
                <h3 style="margin:0 0 10px 0; font-size:1rem; color:var(--music-color);">üéµ Music Sync</h3>
                <input type="file" id="audioFile" accept="audio/*">
                <audio id="audioPlayer" controls style="width:100%; margin-top:5px;"></audio>
                <canvas id="visualizer" class="visualizer-canvas"></canvas>
                <div style="margin-top:10px; font-size:0.8rem; color:#aaa;">
                    Upload MP3 -> Play -> Lights React to Bass
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="offBtn" class="btn-danger">OFF</button>
                <button id="onBtn" class="btn-success">ON</button>
            </div>

            <input type="color" id="colorPicker" value="#ff0000">
            
            <!-- Standard Shows -->
            <div class="show-controls">
                <h3 style="margin:0 0 10px 0; font-size:1rem;">Presets</h3>
                <div style="display:flex; gap:5px; flex-wrap:wrap;">
                    <button onclick="startShow('rgb')" style="flex:1; background:#444;">RGB Fade</button>
                    <button onclick="startShow('police')" style="flex:1; background:#0044cc;">Police</button>
                    <button onclick="startShow('strobe')" style="flex:1; background:#cccc00; color:black;">Strobe</button>
                </div>
                
                <div class="speed-control">
                    <span>Fast</span>
                    <input type="range" id="speedRange" min="100" max="2000" value="500" step="50">
                    <span>Slow</span>
                </div>

                <button id="stopShowBtn" class="hidden btn-danger" style="margin-top:10px;">‚èπ Stop Show</button>
            </div>
            
            <button id="disconnectBtn" style="background: #333; margin-top: 20px;">Disconnect</button>
            <p id="protocol-info" style="margin-top:10px; font-size:0.8rem; color: #8b5cf6;"></p>
        </div>

        <div id="log">Logs will appear here...</div>
    </div>

    <script>
        // --- COMMAND PROTOCOLS ---
        const COMMAND_SETS = [
            {
                name: "Standard (ELK/BLEDOM)",
                writeColor: (r, g, b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]),
                on: new Uint8Array([0xcc, 0x23, 0x33]),
                off: new Uint8Array([0xcc, 0x24, 0x33])
            },
            {
                name: "Lotus/Keepsmile (0x7E)",
                writeColor: (r, g, b) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, 0x10, 0xef]),
                on: new Uint8Array([0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef]),
                off: new Uint8Array([0x7e, 0x04, 0x04, 0x00, 0x00, 0x00, 0xff, 0x00, 0xef])
            },
            {
                name: "Triones/Zengge",
                writeColor: (r, g, b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]),
                on: new Uint8Array([0xcc, 0x23, 0x33]),
                off: new Uint8Array([0xcc, 0x24, 0x33])
            },
            {
                name: "QHM Variant",
                writeColor: (r, g, b) => new Uint8Array([0x56, 0x00, r, g, b, 0xf0, 0xaa]),
                on: new Uint8Array([0xcc, 0x23, 0x33]),
                off: new Uint8Array([0xcc, 0x24, 0x33])
            }
        ];

        // Known UUIDs
        const SERVICES = [
            '0000ffd5-0000-1000-8000-00805f9b34fb',
            '0000ffe5-0000-1000-8000-00805f9b34fb',
            '0000fff0-0000-1000-8000-00805f9b34fb',
            '0000ffe0-0000-1000-8000-00805f9b34fb'
        ];
        
        const CHARACTERISTICS = [
            '0000ffd9-0000-1000-8000-00805f9b34fb',
            '0000ffe9-0000-1000-8000-00805f9b34fb',
            '0000fff3-0000-1000-8000-00805f9b34fb',
            '0000ffe1-0000-1000-8000-00805f9b34fb'
        ];

        // --- STATE ---
        let device, characteristic;
        let showInterval = null; 
        
        // --- AUDIO STATE ---
        let audioCtx, analyser, dataArray;
        let isAudioSetup = false;
        let lastBeatTime = 0;
        let beatColors = [[255,0,0], [0,0,255], [0,255,0], [255,0,255], [0,255,255], [255,255,0]];
        let beatColorIndex = 0;

        // --- UI ELEMENTS ---
        const logBox = document.getElementById('log');
        const protocolSelect = document.getElementById('protocolSelect');

        function log(msg) {
            logBox.innerText = `> ${msg}\n` + logBox.innerText;
        }

        // --- CONNECTION LOGIC ---
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                if (!navigator.bluetooth) throw new Error("Web Bluetooth not supported (Use Bluefy App)");
                log("Scanning...");
                
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: SERVICES
                });

                log(`Connecting to ${device.name}...`);
                
                device.addEventListener('gattserverdisconnected', () => {
                    log("Disconnected.");
                    document.getElementById('connectScreen').classList.remove('hidden');
                    document.getElementById('controlScreen').classList.add('hidden');
                });

                const server = await device.gatt.connect();
                
                // Find valid service
                let service = null;
                for (let uuid of SERVICES) {
                    try {
                        service = await server.getPrimaryService(uuid);
                        break;
                    } catch (e) { }
                }
                if (!service) throw new Error("No service found.");

                // Find valid char
                let char = null;
                for (let uuid of CHARACTERISTICS) {
                    try {
                        char = await service.getCharacteristic(uuid);
                        break;
                    } catch (e) { }
                }
                if (!char) {
                     const chars = await service.getCharacteristics();
                     if(chars.length > 0) char = chars[0];
                     else throw new Error("No characteristic found.");
                }
                
                characteristic = char;
                document.getElementById('connectScreen').classList.add('hidden');
                document.getElementById('controlScreen').classList.remove('hidden');
                log("Ready.");

            } catch (err) {
                log("Error: " + err.message);
            }
        });

        document.getElementById('disconnectBtn').addEventListener('click', () => {
            if (device && device.gatt.connected) device.gatt.disconnect();
        });

        // --- SEND COMMANDS ---
        async function send(data) {
            if (!characteristic) return;
            try {
                await characteristic.writeValue(data);
            } catch (e) {
                // Squelch errors during music playback to avoid lag
            }
        }

        function getActiveProtocol() {
            return COMMAND_SETS[protocolSelect.value];
        }

        document.getElementById('onBtn').addEventListener('click', () => send(getActiveProtocol().on));
        document.getElementById('offBtn').addEventListener('click', () => {
            stopShow();
            send(getActiveProtocol().off);
        });

        const colorPicker = document.getElementById('colorPicker');
        let debounce;
        
        colorPicker.addEventListener('input', (e) => {
            stopShow(); 
            clearTimeout(debounce);
            debounce = setTimeout(() => {
                const hex = e.target.value;
                const r = parseInt(hex.substring(1, 3), 16);
                const g = parseInt(hex.substring(3, 5), 16);
                const b = parseInt(hex.substring(5, 7), 16);
                send(getActiveProtocol().writeColor(r, g, b));
            }, 100);
        });

        // --- MUSIC ENGINE ---
        const audioInput = document.getElementById('audioFile');
        const audioPlayer = document.getElementById('audioPlayer');
        const canvas = document.getElementById('visualizer');
        const ctx = canvas.getContext('2d');

        audioInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const objectUrl = URL.createObjectURL(file);
                audioPlayer.src = objectUrl;
                log("Audio loaded. Press Play.");
                if (!isAudioSetup) setupAudioContext();
            }
        });

        function setupAudioContext() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(audioPlayer);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            isAudioSetup = true;
            visualize();
        }

        function visualize() {
            requestAnimationFrame(visualize);
            
            // Get frequency data (0-255)
            analyser.getByteFrequencyData(dataArray);

            // Draw Background
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / dataArray.length) * 2.5;
            let barHeight;
            let x = 0;

            // Simple Beat Detection Algorithm
            // We check the lower frequencies (Bass)
            let bassTotal = 0;
            let bassCount = 0;
            for(let i = 0; i < 10; i++) { // First 10 bins = Bass
                 bassTotal += dataArray[i];
                 bassCount++;
            }
            const bassLevel = bassTotal / bassCount;

            // Draw bars
            for(let i = 0; i < dataArray.length; i++) {
                barHeight = dataArray[i] / 2;
                ctx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
            }

            // --- LIGHT SYNC LOGIC ---
            // Threshold for beat detection (adjust based on song volume)
            // Limit commands to every 150ms to prevent Bluetooth jamming
            const now = Date.now();
            if (bassLevel > 180 && (now - lastBeatTime > 150)) {
                
                // Beat Detected!
                const proto = getActiveProtocol();
                if(proto && characteristic) {
                    const col = beatColors[beatColorIndex % beatColors.length];
                    
                    // Send color command
                    // Note: We use .catch() to ignore errors if the previous write is still busy
                    characteristic.writeValue(proto.writeColor(col[0], col[1], col[2])).catch(e => {});
                    
                    beatColorIndex++;
                    lastBeatTime = now;
                }
            }
        }

        // --- LIGHT SHOW ENGINE (Legacy) ---
        
        const stopBtn = document.getElementById('stopShowBtn');
        const speedRange = document.getElementById('speedRange');

        window.stopShow = function() {
            if (showInterval) {
                clearInterval(showInterval);
                showInterval = null;
                stopBtn.classList.add('hidden');
                log("Show stopped.");
            }
        };

        stopBtn.addEventListener('click', window.stopShow);

        window.startShow = function(type) {
            stopShow();
            stopBtn.classList.remove('hidden');
            
            const proto = getActiveProtocol();
            if(!proto) { log("Connect first!"); return; }

            const speed = parseInt(speedRange.value);
            let step = 0;
            let sequence = [];

            // Preset Patterns
            const patterns = {
                'rgb': [
                    [255, 0, 0], [0, 255, 0], [0, 0, 255], 
                    [255, 255, 0], [0, 255, 255], [255, 0, 255]
                ],
                'police': [
                    [255, 0, 0], [0, 0, 255], [255, 0, 0], [0, 0, 255]
                ],
                'strobe': [
                    [255, 255, 255], [0, 0, 0]
                ]
            };
            sequence = patterns[type];

            showInterval = setInterval(() => {
                const color = sequence[step % sequence.length];
                send(proto.writeColor(color[0], color[1], color[2]));
                step++;
            }, speed);
        };

    </script>
</body>
</html>
