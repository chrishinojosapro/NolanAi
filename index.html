<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Calibration Probe</title>
    <style>
        :root {
            --bg: #0a0a0c;
            --panel: #16161d;
            --accent: #3b82f6;
            --text: #e0e0e6;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .card {
            background: var(--panel);
            border: 1px solid #333;
            border-radius: 24px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
        }

        h1 { margin: 0; font-size: 1.5rem; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); }
        p { color: #888; font-size: 0.85rem; margin-bottom: 25px; }

        .led-strip-preview {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-bottom: 30px;
            background: #000;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #222;
        }
        .pixel {
            width: 12px; height: 12px; background: #222; border-radius: 2px;
            transition: background 0.1s;
        }
        .pixel.active { background: #ff0000; box-shadow: 0 0 8px #ff0000; }

        .control-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            text-align: left;
        }

        .slider-box {
            grid-column: span 2;
            background: #000;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        label { display: flex; justify-content: space-between; font-size: 0.7rem; color: #666; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }
        
        button {
            padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.9rem;
        }
        .btn-connect { background: #333; color: white; border: 1px solid #444; }
        .btn-probe { background: var(--accent); color: white; grid-column: span 2; }
        .btn-stop { background: #ef4444; color: white; grid-column: span 2; }

        #log {
            font-family: monospace; font-size: 0.75rem; background: #000; padding: 10px; border-radius: 8px; margin-top: 20px;
            height: 80px; overflow-y: auto; color: #3b82f6; text-align: left; border: 1px solid #222;
        }
    </style>
</head>
<body>

    <div class="card">
        <h1>Pixel Probe</h1>
        <p>Testing for Individual LED Addressing</p>

        <div class="led-strip-preview" id="stripPreview">
            <!-- 15 pixels for preview -->
            <div class="pixel"></div><div class="pixel"></div><div class="pixel"></div>
            <div class="pixel"></div><div class="pixel"></div><div class="pixel"></div>
            <div class="pixel"></div><div class="pixel"></div><div class="pixel"></div>
            <div class="pixel"></div><div class="pixel"></div><div class="pixel"></div>
            <div class="pixel"></div><div class="pixel"></div><div class="pixel"></div>
        </div>

        <div class="control-grid">
            <select id="protocol" style="background:#000; color:white; border-radius:8px; padding:10px; border:1px solid #333;">
                <option value="1">Protocol: Lotus (Keepsmile)</option>
                <option value="0">Protocol: ELK (Standard)</option>
            </select>
            <button class="btn-connect" onclick="connect()" id="connBtn">Connect</button>

            <div class="slider-box">
                <label><span>Current Index Target</span> <span id="idxVal">0</span></label>
                <input type="range" id="indexRange" min="0" max="255" value="0" oninput="manualTarget(this.value)">
            </div>

            <button class="btn-probe" id="actionBtn" onclick="toggleProbe()">ðŸ”­ Start Auto-Probe</button>
        </div>

        <div id="log">> System Idle...</div>
    </div>

    <script>
        const PROTOCOLS = [
            { name: "ELK", write: (r,g,b,idx) => new Uint8Array([0x56, r, g, b, idx, 0xf0, 0xaa]), on: [0xcc, 0x23, 0x33] },
            { name: "Lotus", write: (r,g,b,idx) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, idx, 0xef]), on: [0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef] }
        ];

        let device, characteristic;
        let isProbing = false;
        let probeInterval;
        let currentIndex = 0;

        function log(msg) {
            const l = document.getElementById('log');
            l.innerHTML = `> ${msg}<br>` + l.innerHTML;
        }

        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                const services = await server.getPrimaryServices();
                for(let s of services) {
                    const chars = await s.getCharacteristics();
                    for(let c of chars) {
                        if(c.properties.write || c.properties.writeWithoutResponse) { characteristic = c; break; }
                    }
                    if(characteristic) break;
                }
                document.getElementById('connBtn').innerText = "LINKED";
                document.getElementById('connBtn').style.background = "#22c55e";
                log("Connected to " + device.name);
                
                const p = PROTOCOLS[document.getElementById('protocol').value];
                await characteristic.writeValue(new Uint8Array(p.on));
            } catch(e) { log("ERR: " + e.message); }
        }

        function manualTarget(val) {
            currentIndex = parseInt(val);
            document.getElementById('idxVal').innerText = val;
            updateVisualizer(currentIndex);
            sendProbe(currentIndex);
        }

        function updateVisualizer(idx) {
            const pixels = document.querySelectorAll('.pixel');
            pixels.forEach(p => p.classList.remove('active'));
            // Maps 0-255 to 15 preview pixels
            const mappedIdx = Math.floor((idx / 255) * 14);
            pixels[mappedIdx].classList.add('active');
        }

        function toggleProbe() {
            if(isProbing) stopProbe(); else startProbe();
        }

        function startProbe() {
            if(!characteristic) return alert("Connect light first!");
            isProbing = true;
            document.getElementById('actionBtn').innerText = "â¹ Stop Probe";
            document.getElementById('actionBtn').className = "btn-stop";
            currentIndex = 0;
            
            probeInterval = setInterval(() => {
                currentIndex++;
                if(currentIndex > 255) currentIndex = 0;
                
                document.getElementById('indexRange').value = currentIndex;
                document.getElementById('idxVal').innerText = currentIndex;
                updateVisualizer(currentIndex);
                sendProbe(currentIndex);
                
                if(currentIndex % 10 === 0) log("Probing Index: " + currentIndex);
            }, 150);
        }

        function stopProbe() {
            isProbing = false;
            clearInterval(probeInterval);
            document.getElementById('actionBtn').innerText = "ðŸ”­ Start Auto-Probe";
            document.getElementById('actionBtn').className = "btn-probe";
            log("Probe Halted at Index: " + currentIndex);
        }

        async function sendProbe(idx) {
            if(!characteristic) return;
            const p = PROTOCOLS[document.getElementById('protocol').value];
            // Send Red [255,0,0] with the current Index byte
            try {
                await characteristic.writeValue(p.write(255, 0, 0, idx));
            } catch(e) {}
        }
    </script>
</body>
</html>
