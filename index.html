<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Wars Battle Sequence</title>
    <style>
        :root {
            --bg: #000;
            --text: #eee;
            --red: #ff0000;
            --blue: #0044ff;
            --white: #ffffff;
            --panel: #1a1a1a;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background-color 0.05s;
        }

        .container {
            text-align: center;
            z-index: 10;
            background: rgba(20, 20, 20, 0.9);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid #333;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            margin: 0 0 20px 0;
            font-size: 1.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(to right, #ff0000, #ffffff, #0044ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Sound FX Section */
        .sfx-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .sfx-upload {
            position: relative;
            overflow: hidden;
            border: 1px dashed #555;
            border-radius: 8px;
            padding: 15px 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s;
            color: #888;
            background: rgba(255,255,255,0.05);
        }
        .sfx-upload:hover { border-color: #fff; color: #fff; }
        .sfx-upload.loaded { border-color: #22c55e; color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        
        .sfx-upload input { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .sfx-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }

        select {
            background: #222;
            color: white;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 5px;
            width: 100%;
            margin-bottom: 20px;
            font-size: 1rem;
        }

        button {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        button:hover { background: #444; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-connect { border-color: #0ea5e9; color: #0ea5e9; }
        .btn-connect:hover { background: rgba(14, 165, 233, 0.1); }
        
        .btn-start { 
            background: linear-gradient(45deg, #880000, #000088); 
            border: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .btn-start:hover { transform: scale(1.02); }

        .status { margin-top: 20px; font-size: 0.9rem; color: #888; height: 20px; }

        /* Saber Visualizers */
        .saber-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            height: 150px;
            align-items: flex-end;
        }

        .saber {
            width: 12px;
            height: 0%;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 0 20px currentColor;
            transition: height 0.1s ease-out;
            position: relative;
        }
        .saber::after {
            content: '';
            position: absolute; bottom: -20px; left: -4px; width: 20px; height: 20px; background: #888; border-radius: 2px;
        }

        #saber-left { background: red; color: red; }
        #saber-right { background: #0044ff; color: #0044ff; }

        .flash-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; z-index: 5;
            transition: opacity 0.05s;
        }

        #timeline-progress {
            width: 100%; height: 4px; background: #333; margin-top: 20px; position: relative;
        }
        #progress-bar {
            width: 0%; height: 100%; background: white; transition: width 0.1s linear;
        }

    </style>
</head>
<body>

    <div class="flash-overlay" id="flash"></div>

    <div class="container">
        <h1>Duel FX Studio</h1>
        
        <div class="saber-container">
            <div id="saber-left" class="saber"></div>
            <div id="saber-right" class="saber"></div>
        </div>

        <!-- Sound FX Inputs -->
        <div class="sfx-grid">
            <label class="sfx-upload" id="lbl-ignite">
                <span class="sfx-icon">üîä</span>
                Ignition
                <input type="file" onchange="loadSound('ignite', this)" accept="audio/*">
            </label>
            <label class="sfx-upload" id="lbl-clash">
                <span class="sfx-icon">üí•</span>
                Clash/Hit
                <input type="file" onchange="loadSound('clash', this)" accept="audio/*">
            </label>
            <label class="sfx-upload" id="lbl-retract">
                <span class="sfx-icon">‚¨áÔ∏è</span>
                Retract
                <input type="file" onchange="loadSound('retract', this)" accept="audio/*">
            </label>
        </div>

        <select id="protocol">
            <option value="1">Protocol: Lotus/Keepsmile (0x7E)</option>
            <option value="0">Protocol: ELK-BLEDOM (Standard)</option>
            <option value="2">Protocol: Triones</option>
        </select>

        <button class="btn-connect" id="connectBtn" onclick="connect()">üì° Connect Light</button>
        <button class="btn-start" id="startBtn" onclick="startBattle()" disabled>‚öîÔ∏è Start Battle</button>
        <button onclick="stopBattle()" style="background:#333; font-size:0.9rem; padding:10px;">‚èπ Stop / Reset</button>

        <div id="timeline-progress"><div id="progress-bar"></div></div>
        <div class="status" id="status">Upload sounds & Connect...</div>
    </div>

    <script>
        // --- SOUND ENGINE ---
        const sounds = {
            ignite: null,
            clash: null,
            retract: null
        };

        function loadSound(type, input) {
            const file = input.files[0];
            if(!file) return;
            const url = URL.createObjectURL(file);
            sounds[type] = new Audio(url);
            
            // UI Feedback
            const lbl = document.getElementById('lbl-'+type);
            lbl.classList.add('loaded');
            lbl.querySelector('.sfx-icon').innerText = "‚úÖ";
        }

        function playSound(type) {
            if (sounds[type]) {
                sounds[type].currentTime = 0;
                sounds[type].play().catch(e => console.log("Audio play error", e));
            }
        }

        // --- PROTOCOLS ---
        const PROTOCOLS = [
            { name: "ELK", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]) },
            { name: "Lotus", write: (r,g,b) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, 0x10, 0xef]), off: new Uint8Array([0x7e, 0x04, 0x04, 0x00, 0x00, 0x00, 0xff, 0x00, 0xef]), on: new Uint8Array([0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef]) },
            { name: "Triones", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]) }
        ];

        // --- BATTLE SCRIPT ---
        const BATTLE_SCRIPT = [
            { type: 'off', duration: 1000, desc: "Silence..." },
            { type: 'color', r: 255, g: 0, b: 0, duration: 2000, desc: "Sith Ignite" }, // Play Ignite
            { type: 'off', duration: 1500, desc: "Retract/Silence" }, // Play Retract
            { type: 'color', r: 0, g: 0, b: 255, duration: 2000, desc: "Jedi Ignite" }, // Play Ignite
            { type: 'off', duration: 500, desc: "Ready..." },

            // Sparring
            { type: 'clash', duration: 200, desc: "CLASH!" }, // Play Clash
            { type: 'color', r: 255, g: 0, b: 0, duration: 800, desc: "Red Pushes" },
            { type: 'off', duration: 400, desc: "Break" }, // Short break, maybe no retract sound?

            { type: 'clash', duration: 200, desc: "CLASH!" },
            { type: 'color', r: 0, g: 0, b: 255, duration: 800, desc: "Blue Parries" },
            { type: 'off', duration: 400, desc: "Break" },

            { type: 'clash', duration: 100, desc: "Hit" },
            { type: 'color', r: 255, g: 0, b: 0, duration: 400, desc: "Red" },
            { type: 'off', duration: 200, desc: "Gap" },

            { type: 'clash', duration: 100, desc: "Hit" },
            { type: 'color', r: 0, g: 0, b: 255, duration: 400, desc: "Blue" },
            { type: 'off', duration: 200, desc: "Gap" },

            // Flurry
            { type: 'flash', r: 255, g: 255, b: 255, duration: 150, desc: "Flurry" }, // Play Clash
            { type: 'color', r: 255, g: 0, b: 0, duration: 200, desc: "Red" },
            { type: 'flash', r: 255, g: 255, b: 255, duration: 150, desc: "Flurry" },
            { type: 'color', r: 0, g: 0, b: 255, duration: 200, desc: "Blue" },
            { type: 'off', duration: 100, desc: "Gap" },
            
            { type: 'flash', r: 255, g: 255, b: 255, duration: 100, desc: "Rapid" },
            { type: 'color', r: 255, g: 0, b: 0, duration: 150, desc: "Red" },
            { type: 'flash', r: 255, g: 255, b: 255, duration: 100, desc: "Rapid" },
            { type: 'color', r: 0, g: 0, b: 255, duration: 150, desc: "Blue" },
            { type: 'off', duration: 50, desc: "Gap" },

            // Finale
            { type: 'clash', duration: 50, desc: "CRASH" },
            { type: 'clash', duration: 50, desc: "CRASH" },
            { type: 'clash', duration: 50, desc: "CRASH" },
            { type: 'color', r: 255, g: 100, b: 0, duration: 2000, desc: "Lock Up (Orange)" }, 

            { type: 'off', duration: 0, desc: "End" } // Play Retract
        ];

        // --- STATE ---
        let device, characteristic;
        let isRunning = false;
        let timeoutId = null;

        // --- BLUETOOTH ---
        async function connect() {
            const status = document.getElementById('status');
            try {
                if (!navigator.bluetooth) throw new Error("Bluetooth not supported");
                status.innerText = "Scanning...";
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                const uuids = ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
                let service;
                for(let u of uuids) { try{ service = await server.getPrimaryService(u); break; }catch(e){} }
                const charUUIDs = ['0000ffd9-0000-1000-8000-00805f9b34fb', '0000ffe9-0000-1000-8000-00805f9b34fb', '0000fff3-0000-1000-8000-00805f9b34fb'];
                for(let c of charUUIDs) { try{ characteristic = await service.getCharacteristic(c); break; }catch(e){} }
                if(characteristic) {
                    status.innerText = "Connected: " + device.name;
                    status.style.color = "#22c55e";
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('startBtn').disabled = false;
                    sendOn();
                }
            } catch(e) { status.innerText = "Error: " + e.message; status.style.color = "#ef4444"; }
        }

        // --- COMMANDS ---
        async function sendRGB(r, g, b) {
            updateUI(r, g, b, 1);
            if(!characteristic) return;
            const pid = document.getElementById('protocol').value;
            const data = PROTOCOLS[pid].write(r,g,b);
            try { 
                if(PROTOCOLS[pid].on) await characteristic.writeValue(PROTOCOLS[pid].on);
                await characteristic.writeValue(data); 
            } catch(e){}
        }

        async function sendOff() {
            updateUI(0, 0, 0, 0);
            if(!characteristic) return;
            const pid = document.getElementById('protocol').value;
            try { await characteristic.writeValue(PROTOCOLS[pid].off); } catch(e){}
        }
        
        async function sendOn() {
            if(!characteristic) return;
            const pid = document.getElementById('protocol').value;
            try { await characteristic.writeValue(PROTOCOLS[pid].on); } catch(e){}
        }

        function updateUI(r, g, b, brightness) {
            document.body.style.backgroundColor = `rgb(${r*0.2}, ${g*0.2}, ${b*0.2})`;
            const left = document.getElementById('saber-left');
            const right = document.getElementById('saber-right');
            if (brightness === 0) {
                left.style.height = '0%'; right.style.height = '0%';
            } else if (r > b) {
                left.style.height = '100%'; right.style.height = '50%'; left.style.boxShadow = `0 0 50px red`;
            } else if (b > r) {
                right.style.height = '100%'; left.style.height = '50%'; right.style.boxShadow = `0 0 50px blue`;
            } else {
                left.style.height = '80%'; right.style.height = '80%';
                document.getElementById('flash').style.opacity = 0.8;
                setTimeout(() => document.getElementById('flash').style.opacity = 0, 50);
            }
        }

        // --- ENGINE ---
        function startBattle() {
            if(isRunning) return;
            isRunning = true;
            document.getElementById('startBtn').innerText = "Running...";
            runStep(0);
        }

        function stopBattle() {
            isRunning = false;
            clearTimeout(timeoutId);
            sendOff();
            document.getElementById('startBtn').innerText = "‚öîÔ∏è Start Battle";
            document.getElementById('status').innerText = "Stopped.";
            document.getElementById('progress-bar').style.width = '0%';
        }

        function runStep(index) {
            if (!isRunning || index >= BATTLE_SCRIPT.length) {
                stopBattle();
                return;
            }

            const step = BATTLE_SCRIPT[index];
            const totalSteps = BATTLE_SCRIPT.length;
            document.getElementById('status').innerText = `Step ${index+1}/${totalSteps}: ${step.desc}`;
            document.getElementById('progress-bar').style.width = `${(index/totalSteps)*100}%`;

            // AUDIO & LIGHT TRIGGER LOGIC
            if (step.type === 'off') {
                sendOff();
                // Only play retract if it's a significant pause (> 400ms)
                if (step.duration > 400) playSound('retract');
            } 
            else if (step.type === 'color') {
                sendRGB(step.r, step.g, step.b);
                // Assume color change = Ignition or Clash push
                if (step.desc.includes("Ignite")) playSound('ignite');
            }
            else if (step.type === 'clash' || step.type === 'flash') {
                sendRGB(255, 255, 255); // Flash White
                playSound('clash');
                setTimeout(() => { if(isRunning) sendOff(); }, step.duration - 50);
            }

            timeoutId = setTimeout(() => runStep(index + 1), step.duration);
        }

    </script>
</body>
</html>
