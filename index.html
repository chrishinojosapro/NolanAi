<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI FX Studio v12 (Custom Data)</title>
    <style>
        :root {
            --bg: #09090b;
            --panel: #18181b;
            --border: #27272a;
            --text: #e4e4e7;
            --accent: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --sfx-1: #3b82f6;
            --sfx-2: #f59e0b;
            --sfx-3: #ec4899;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .app-container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 20px; }

        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; background: linear-gradient(90deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        
        .status-badge { font-size: 0.75rem; background: #27272a; padding: 4px 8px; border-radius: 4px; color: #71717a; border: 1px solid #3f3f46; }
        .status-badge.connected { color: var(--success); border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }

        .section { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .section-title { margin: 0 0 15px 0; font-size: 0.9rem; font-weight: 600; color: #a1a1aa; text-transform: uppercase; letter-spacing: 0.5px; }

        .audio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .file-upload {
            position: relative; background: #27272a; border: 1px dashed #52525b; border-radius: 8px; padding: 12px;
            text-align: center; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center;
            gap: 8px; font-size: 0.85rem; color: #a1a1aa;
        }
        .file-upload:hover { border-color: var(--text); color: var(--text); background: #3f3f46; }
        .file-upload.loaded { border-style: solid; background: rgba(255,255,255,0.05); }
        .file-upload input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }

        textarea {
            width: 100%; height: 80px; background: #000; border: 1px solid var(--border); border-radius: 8px;
            color: var(--text); padding: 12px; font-family: inherit; resize: vertical; box-sizing: border-box; margin-bottom: 10px;
        }
        textarea:focus { outline: none; border-color: var(--accent); }

        button {
            padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 0.95rem;
        }
        button:hover { filter: brightness(1.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-gen { background: var(--accent); color: white; width: 100%; }
        .btn-play { background: var(--success); color: black; flex: 2; font-size: 1.1rem;}
        .btn-stop { background: var(--danger); color: white; flex: 1; }
        .btn-connect { background: #3f3f46; color: white; padding: 6px 12px; font-size: 0.8rem; }
        .btn-battle { background: #eab308; color: black; width: 100%; margin-top: 10px; }

        .script-view {
            background: #000; border: 1px solid var(--border); border-radius: 8px; height: 200px; overflow-y: auto;
            padding: 10px; font-family: monospace; font-size: 0.8rem; color: #a1a1aa;
        }
        .script-line { display: flex; gap: 10px; padding: 4px 0; border-bottom: 1px solid #222; }
        .script-time { color: var(--accent); min-width: 50px; }
        .script-line.active { background: rgba(255,255,255,0.1); color: white; }

        .progress-bar { height: 4px; width: 100%; background: #27272a; margin-top: 20px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--success); transition: width 0.1s linear; }
        .control-row { display: flex; gap: 10px; margin-top: 10px; }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- HEADER -->
        <header>
            <div style="display: flex; align-items: center; gap: 10px;">
                <h1>AI FX Studio</h1>
                <div id="connectionStatus" class="status-badge">Disconnected</div>
            </div>
            <div style="display:flex; gap:10px;">
                <select id="protocolSelect" style="background:#27272a; color:#fff; border:1px solid #3f3f46; border-radius:6px; padding:5px;">
                    <option value="1">Lotus/Keepsmile</option>
                    <option value="0">ELK-BLEDOM</option>
                    <option value="2">Triones</option>
                </select>
                <button class="btn-connect" id="connectBtn" onclick="connect()">üì° Connect</button>
            </div>
        </header>

        <!-- 1. AUDIO ASSETS -->
        <div class="section">
            <h2 class="section-title">1. Upload Assets</h2>
            <div class="audio-grid">
                <label class="file-upload" id="lbl-bg">üéµ Backing Track <input type="file" accept="audio/*" onchange="loadAudio('bg', this)"></label>
                <label class="file-upload sfx1" id="lbl-sfx1">üîµ SFX 1 (Ignite) <input type="file" accept="audio/*" onchange="loadAudio('sfx1', this)"></label>
                <label class="file-upload sfx2" id="lbl-sfx2">üí• SFX 2 (Clash) <input type="file" accept="audio/*" onchange="loadAudio('sfx2', this)"></label>
                <label class="file-upload sfx3" id="lbl-sfx3">‚¨áÔ∏è SFX 3 (Retract) <input type="file" accept="audio/*" onchange="loadAudio('sfx3', this)"></label>
            </div>
        </div>

        <!-- 2. AI GENERATOR -->
        <div class="section">
            <h2 class="section-title">2. Choreography</h2>
            <p style="font-size:0.8rem; color:#aaa; margin-top:0;">Using Scanned Library (200 Modes) for precise control.</p>
            
            <!-- AI Prompt (Optional) -->
            <div style="display:none;">
                <input type="password" id="apiKey" placeholder="OpenRouter API Key">
                <textarea id="promptInput" placeholder="Describe..."></textarea>
                <button class="btn-gen" onclick="generateShow()">‚ú® Generate with AI</button>
            </div>
            
            <button class="btn-battle" onclick="generateStarWars()">‚öîÔ∏è Generate Star Wars Battle (Using Scanned Data)</button>
        </div>

        <!-- 3. PLAYBACK -->
        <div class="section">
            <h2 class="section-title">3. Run Show</h2>
            <div class="script-view" id="scriptView">
                <div style="text-align:center; padding-top:80px; color:#444;">Script will appear here...</div>
            </div>
            
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div style="text-align:right; font-size:0.8rem; color:#666; margin-top:5px;" id="timeDisplay">0:00</div>

            <div class="control-row">
                <button class="btn-play" id="playBtn" onclick="togglePlay()" disabled>‚ñ∂ Run Show</button>
                <button class="btn-stop" onclick="stopShow()">‚èπ Reset</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        const PROTOCOLS = [
            { name: "ELK", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]), setMode: (m) => new Uint8Array([0xBB, m, 0x03, 0x44]) },
            { name: "Lotus", write: (r,g,b) => new Uint8Array([0x7e, 0x07, 0x05, 0x03, r, g, b, 0x10, 0xef]), off: new Uint8Array([0x7e, 0x04, 0x04, 0x00, 0x00, 0x00, 0xff, 0x00, 0xef]), on: new Uint8Array([0x7e, 0x04, 0x04, 0xf0, 0x00, 0x01, 0xff, 0x00, 0xef]), setMode: (m) => new Uint8Array([0x7e, 0x05, 0x03, m, 0x03, 0xff, 0xff, 0x00, 0xef]) },
            { name: "Triones", write: (r,g,b) => new Uint8Array([0x56, r, g, b, 0x00, 0xf0, 0xaa]), off: new Uint8Array([0xcc, 0x24, 0x33]), on: new Uint8Array([0xcc, 0x23, 0x33]), setMode: (m) => new Uint8Array([0xBB, m, 0x03, 0x44]) }
        ];

        // --- YOUR SCANNED LIBRARY ---
        const LIBRARY = {
            "196": "Blackout/Off",
            "198": "Blackout/Off",
            "80": "Solid Red (Vader)",
            "90": "Solid Red (Alt)",
            "58": "Solid Red (Alt)",
            "89": "Red Random/Flash (Vader Action)",
            "77": "Solid Blue (Obi)",
            "53": "Blue Random/Flash (Obi Action)",
            "161": "White Random/Flash (Clash)",
            "180": "Solid White",
            "45": "Red/Blue Gradient (Lockup)"
        };

        // --- STATE ---
        let characteristic;
        let audioBuffers = { bg: null, sfx1: null, sfx2: null, sfx3: null };
        let showEvents = [];
        let isPlaying = false;
        let startTime = 0;
        let animationFrame;
        let audioDuration = 60;

        // --- AUDIO ENGINE ---
        function loadAudio(slot, input) {
            const file = input.files[0];
            if(!file) return;
            const url = URL.createObjectURL(file);
            audioBuffers[slot] = new Audio(url);
            if(slot === 'bg') {
                audioBuffers[slot].addEventListener('loadedmetadata', function() { audioDuration = audioBuffers[slot].duration; });
            }
            document.getElementById('lbl-'+slot).classList.add('loaded');
        }

        function playSound(slot) {
            const audio = audioBuffers[slot];
            if(audio) { audio.currentTime = 0; audio.play().catch(e=>{}); }
        }
        
        function stopAllSound() {
            Object.values(audioBuffers).forEach(a => { if(a) { a.pause(); a.currentTime = 0; } });
        }

        // --- LIGHT CONTROL ---
        async function sendEvent(ev) {
            if(!characteristic) return;
            const pid = document.getElementById('protocolSelect').value;
            const p = PROTOCOLS[pid];

            try {
                if (ev.type === 'off') {
                    await characteristic.writeValue(p.off);
                } else if (ev.type === 'mode') {
                    if(p.on) await characteristic.writeValue(p.on);
                    await characteristic.writeValue(p.setMode(ev.val));
                }
            } catch(e) { console.error("BT Error", e); }
        }

        // --- SMART GENERATOR ---
        function generateStarWars() {
            const events = [];
            let t = 0;
            const dur = Math.floor(audioDuration);
            
            // 1. Intro (Silence)
            events.push({ time: 0, type: 'off', desc: "Silence" });
            t += 5;

            // 2. Vader Ignites
            events.push({ time: t, type: 'mode', val: 80, sound: 'sfx1', desc: "Vader Ignite (Red)" });
            t += 3;

            // 3. Obi Ignites
            events.push({ time: t, type: 'mode', val: 77, sound: 'sfx1', desc: "Obi Ignite (Blue)" });
            t += 3;

            // 4. Battle Loop
            const battleEnd = dur - 5;
            while(t < battleEnd) {
                const action = Math.random();
                
                if(action < 0.3) {
                    // Clash
                    events.push({ time: t, type: 'mode', val: 161, sound: 'sfx2', desc: "Clash (White)" });
                    t += 0.3; // Fast flash
                    // Return to previous color randomly
                    events.push({ time: t, type: 'mode', val: Math.random()>0.5 ? 89 : 53, desc: "Recoil" });
                    t += 1 + Math.random();
                } else if (action < 0.6) {
                    // Vader Attack
                    events.push({ time: t, type: 'mode', val: 89, desc: "Vader Swing (Red Flash)" });
                    t += 1 + Math.random();
                } else {
                    // Obi Attack
                    events.push({ time: t, type: 'mode', val: 53, desc: "Obi Swing (Blue Flash)" });
                    t += 1 + Math.random();
                }
            }
            
            // 5. Finale
            events.push({ time: battleEnd, type: 'mode', val: 196, sound: 'sfx3', desc: "End/Blackout" });

            showEvents = events;
            renderScript();
            document.getElementById('playBtn').disabled = false;
            alert("Battle Generated!");
        }

        function renderScript() {
            const container = document.getElementById('scriptView');
            container.innerHTML = "";
            showEvents.forEach((ev, i) => {
                const div = document.createElement('div');
                div.className = 'script-line';
                div.id = 'line-'+i;
                div.innerHTML = `<div class="script-time">${ev.time.toFixed(1)}s</div><div class="script-action">${ev.desc}</div>`;
                container.appendChild(div);
            });
        }

        // --- PLAYBACK ---
        function togglePlay() { if(isPlaying) stopShow(); else runShow(); }

        function runShow() {
            if(showEvents.length === 0) return;
            isPlaying = true;
            startTime = Date.now();
            document.getElementById('playBtn').innerText = "Running...";
            playSound('bg');
            showEvents.forEach(e => e.executed = false);
            loop();
        }

        function stopShow() {
            isPlaying = false;
            cancelAnimationFrame(animationFrame);
            stopAllSound();
            sendEvent({ type: 'off' });
            document.getElementById('playBtn').innerText = "‚ñ∂ Run Show";
        }

        function loop() {
            if(!isPlaying) return;
            const now = (Date.now() - startTime) / 1000;
            const maxTime = showEvents[showEvents.length-1].time + 2;
            
            document.getElementById('timeDisplay').innerText = now.toFixed(1);
            document.getElementById('progressFill').style.width = (now/maxTime)*100 + "%";

            showEvents.forEach((ev, i) => {
                if(ev.time <= now && !ev.executed) {
                    sendEvent(ev);
                    if(ev.sound) playSound(ev.sound);
                    ev.executed = true;
                    document.querySelectorAll('.script-line').forEach(l => l.classList.remove('active'));
                    const el = document.getElementById('line-'+i);
                    if(el) { el.classList.add('active'); el.scrollIntoView({behavior:"smooth", block:"center"}); }
                }
            });
            
            if(now > maxTime) stopShow();
            else animationFrame = requestAnimationFrame(loop);
        }

        // --- BLUETOOTH ---
        async function connect() {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                const uuids = ['0000ffd5-0000-1000-8000-00805f9b34fb', '0000ffe5-0000-1000-8000-00805f9b34fb', '0000fff0-0000-1000-8000-00805f9b34fb'];
                let service;
                for(let u of uuids) { try{ service = await server.getPrimaryService(u); break; }catch(e){} }
                const charUUIDs = ['0000ffd9-0000-1000-8000-00805f9b34fb', '0000ffe9-0000-1000-8000-00805f9b34fb', '0000fff3-0000-1000-8000-00805f9b34fb'];
                for(let c of charUUIDs) { try{ characteristic = await service.getCharacteristic(c); break; }catch(e){} }

                if(characteristic) {
                    document.getElementById('connectionStatus').innerText = "Connected";
                    document.getElementById('connectionStatus').classList.add('connected');
                    document.getElementById('connectBtn').style.display = 'none';
                    sendEvent({type:'off'});
                }
            } catch(e) { alert("Error: " + e.message); }
        }
    </script>
</body>
</html>
