<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Nolan AI</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nolan AI Partner">
<link rel="apple-touch-icon" href="https://i.imgur.com/8Qp4R0K.png"> 

<style>
/* --- BASE & THEME --- */
:root {
  --bg-dark: #000000; --glass-surface: rgba(20, 20, 20, 0.85); --glass-border: rgba(255, 255, 255, 0.12); --text-main: #ffffff; --text-muted: #98989d; --gradient-accent: linear-gradient(135deg, #0A84FF, #BF5AF2); --gradient-ai: linear-gradient(135deg, #34C759, #30B0C7); --radius-card: 24px; --radius-pill: 100px; --blur: 40px; --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; font-family: var(--font-stack); color: var(--text-main); background-color: var(--bg-dark); background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E"); height: 100vh; overflow: hidden; display: flex; flex-direction: column;}
.frosted { background: var(--glass-surface); backdrop-filter: blur(var(--blur)) saturate(120%); -webkit-backdrop-filter: blur(var(--blur)) saturate(120%); border: 1px solid var(--glass-border); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6); }
.app-container { width: 100%; max-width: 900px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; padding: 20px; }

/* --- HEADER & CONTROLS --- */
.topbar { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-radius: var(--radius-card); margin-bottom: 20px; flex-shrink: 0; }
.topbar-controls { display: flex; gap: 6px; align-items: center; } 
.brand { display: flex; align-items: center; gap: 16px; }
.brand-icon { height: 40px; width: 40px; background: var(--gradient-ai); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
.brand h1 { font-size: 1.2rem; font-weight: 700; margin: 0; letter-spacing: -0.02em; background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.status-badge { font-size: 0.75rem; color: #a0f0b0; background: rgba(52, 199, 89, 0.1); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(52, 199, 89, 0.3); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
#refresh-btn { 
    height: 40px; width: 40px; 
    border-radius: 50%;
    background: var(--glass-surface);
    border: 1px solid var(--glass-border);
    color: #eee;
    font-size: 1.2rem;
    cursor: pointer;
    transition: transform 0.2s;
}
#refresh-btn:hover { background: rgba(255, 255, 255, 0.1); }
#refresh-btn:active { transform: scale(0.95); }

/* --- CHAT LOG & BUBBLES --- */
#chat-window { flex: 1; border-radius: var(--radius-card); display: flex; flex-direction: column; overflow: hidden; position: relative; }
#chat-log { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
#chat-log::-webkit-scrollbar { width: 6px; } #chat-log::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
.msg-row { display: flex; align-items: flex-end; gap: 10px; max-width: 85%; animation: fadeUp 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
.msg-row.user { align-self: flex-end; flex-direction: row-reverse; }
.msg-row.ai { align-self: flex-start; }
.avatar { height: 32px; width: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.8rem; flex-shrink: 0; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
.user .avatar { background: var(--gradient-accent); } .ai .avatar { background: var(--gradient-ai); }
.bubble { padding: 14px 18px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.1); word-wrap: break-word; }
.user .bubble { background: var(--gradient-accent); color: #fff; border-bottom-right-radius: 4px; }
.ai .bubble { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.05); color: #eee; border-bottom-left-radius: 4px; }

/* --- INPUT & BUTTONS --- */
.input-area { padding: 20px; background: rgba(0,0,0,0.3); border-top: 1px solid var(--glass-border); display: flex; gap: 12px; align-items: center; }
input#msg { flex: 1; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 0 20px; border-radius: var(--radius-pill); font-family: inherit; font-size: 1rem; outline: none; transition: all 0.2s ease; height: 50px; }
button.chat-btn { height: 50px; padding: 0 28px; border-radius: var(--radius-pill); border: none; font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: transform 0.2s, background 0.2s; }
button#send { background: var(--gradient-accent); color: #fff; box-shadow: 0 4px 15px rgba(10, 132, 255, 0.3); }
button#mic-btn { width: 50px; padding: 0; border-radius: 50%; background: rgba(255, 255, 255, 0.1); color: #fff; font-size: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
button#mic-btn.listening { background: var(--gradient-accent); animation: pulse 1s infinite; }

/* --- TYPING INDICATOR (POLISHED) --- */
.typing-indicator { 
    padding: 10px 24px; 
    font-size: 0.85rem; 
    color: var(--text-muted);
    font-weight: 500;
    display: flex; 
    align-items: center;
    gap: 8px;
    display: none;
}
.typing-indicator.show { display: flex; }
.typing-indicator::after {
    content: ". . .";
    color: #fff;
    font-size: 1.5rem;
    animation: dotPulse 1.5s infinite;
    line-height: 0;
}

/* --- ANIMATIONS & MOBILE --- */
@keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
@keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(10, 132, 255, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); } }
@keyframes dotPulse { 0%, 20% { opacity: 0.2; } 40% { opacity: 1; } 100% { opacity: 0.2; } }

@media(max-width: 600px) { 
  .app-container { padding: 10px; } .topbar { margin-bottom: 10px; padding: 12px 16px; } 
  .topbar-controls { gap: 6px; }
  .input-area { padding: 12px; gap: 8px; }
  button#send { padding: 0 15px; font-size: 0.9rem; }
  button#mic-btn { width: 45px; height: 45px; font-size: 1.3rem; }
  #refresh-btn { width: 35px; height: 35px; font-size: 1rem; }
}
</style>
</head>
<body onload="initializeChat()">

<div class="app-container">
  <div class="frosted topbar">
    <div class="brand">
      <div class="brand-icon">N</div>
      <div>
        <h1>Nolan AI</h1>
        <div style="font-size:0.8rem; color:var(--text-muted);">Partner Edition</div>
      </div>
    </div>
    <div class="topbar-controls">
        <button id="refresh-btn" class="frosted">üîÑ</button>
        <div class="status-badge">Online</div>
    </div>
  </div>

  <div id="chat-window" class="frosted">
    <div id="chat-log">
    </div>
    
    <div class="typing-indicator" id="indicator">Nolan is thinking...</div>

    <div class="input-area">
      <input type="text" id="msg" placeholder="Ask Nolan anything or press the mic..." autocomplete="off">
      <button id="mic-btn" class="chat-btn">üéôÔ∏è</button>
      <button id="send" class="chat-btn">Send</button>
    </div>
  </div>
</div>

<script>
    // ---------------------------------------------------------
    // CONFIGURED WITH YOUR FINAL URL
    // ---------------------------------------------------------
    const API_URL = "https://script.google.com/macros/s/AKfycbwWAMU7vvPRKmAt8Fb-a9xrXrcJjvvXwdbHYOOoR6BnMaThEabSVQsPoKipVRcTcCWf/exec"; 

    const input = document.getElementById('msg');
    const btn = document.getElementById('send');
    const log = document.getElementById('chat-log');
    const indicator = document.getElementById('indicator');
    const micBtn = document.getElementById('mic-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    
    // Web Speech API setup
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    
    // --- EVENT LISTENERS ---
    input.addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
    btn.addEventListener('click', send);
    refreshBtn.addEventListener('click', () => { location.reload(); });

    if (recognition) {
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        micBtn.addEventListener('click', () => {
            if (micBtn.classList.contains('listening')) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        recognition.onstart = function() {
            micBtn.classList.add('listening');
            micBtn.innerHTML = 'üî¥';
            input.placeholder = 'Listening... Speak now.';
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            input.value = transcript;
            send();
        };

        recognition.onend = function() {
            micBtn.classList.remove('listening');
            micBtn.innerHTML = 'üéôÔ∏è';
            input.placeholder = 'Ask Nolan anything or press the mic...';
        };

        recognition.onerror = function(event) {
             console.error('Speech Recognition Error:', event.error);
             recognition.onend(); 
        };
    } else {
        micBtn.style.display = 'none';
    }


    function addMsg(text, type) {
        const row = document.createElement('div');
        row.className = `msg-row ${type}`;
        
        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerText = type === 'user' ? 'C' : 'N';
        
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerText = text;
        
        row.appendChild(avatar);
        row.appendChild(bubble);
        log.appendChild(row);
        log.scrollTop = log.scrollHeight;
    }

    async function send() {
        const txt = input.value.trim();
        if(!txt) return;

        addMsg(txt, 'user');
        input.value = '';
        input.disabled = true;
        btn.disabled = true;
        if (micBtn) micBtn.disabled = true;
        indicator.classList.add('show');

        try {
            const url = API_URL + "?q=" + encodeURIComponent(txt);
            
            const res = await fetch(url, { method: "GET", redirect: "follow" });

            if (!res.ok) throw new Error(`Server Error: ${res.status}`);

            const data = await res.json();
            addMsg(data.reply, 'ai');

        } catch (error) {
            console.error("Fetch Error:", error);
            addMsg("Connection Error: " + error.message, 'ai');
        } finally {
            input.disabled = false;
            btn.disabled = false;
            if (micBtn) micBtn.disabled = false;
            input.focus();
            indicator.classList.remove('show');
        }
    }

    // --- INITIALIZATION LOGIC (Proactive Briefing) ---
    async function initializeChat() {
        const initCommand = "nolan_init"; 
        
        input.disabled = true;
        btn.disabled = true;
        if (micBtn) micBtn.disabled = true;
        indicator.classList.add('show');
        
        log.innerHTML = ""; // Clear history on load

        try {
            const url = API_URL + "?q=" + encodeURIComponent(initCommand);
            const res = await fetch(url, { method: "GET", redirect: "follow" });
            const data = await res.json();
            
            await new Promise(r => setTimeout(r, 1000)); 
            
            addMsg(data.reply, 'ai');

        } catch (error) {
            console.error("Initialization failed:", error);
            addMsg("Nolan is having trouble loading the system briefing. Please type a message to wake him up.", 'ai');
        } finally {
            input.disabled = false;
            btn.disabled = false;
            if (micBtn) micBtn.disabled = false;
            input.focus();
            indicator.classList.remove('show');
        }
    }
</script>
</body>
</html>
